/*
Copyright:    (C) 2014-2016 Emmanuel Bertin - IAP/CNRS/UPMC,
                            Chiara Marmo - IDES/Paris-Sud,
                            Ruven Pillay - C2RMF/CNRS
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are
permitted provided that the following conditions are met:

   1. Redistributions of source code must retain the above copyright notice, this list of
      conditions and the following disclaimer.

   2. Redistributions in binary form must reproduce the above copyright notice, this list
      of conditions and the following disclaimer in the documentation and/or other materials
      provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

if(L.Projection.WCS=L.Class.extend({bounds:L.bounds([-.5,-.5],[.5,.5]),project:function(t){var e=this._raDecToPhiTheta(this.celsysflag?this.eqToCelsys(t):t);return e.lat=this._thetaToR(e.lat),this._redToPix(this._phiRToRed(e))},unproject:function(t){var e=this._redToPhiR(this._pixToRed(t));e.lat=this._rToTheta(e.lat);var i=this._phiThetaToRADec(e);return i.lng<-180&&(i.lng+=360),this.celsysflag?this.celsysToEq(i):i},_natpole:function(){var t=(Math.PI/180,this.projparam),e=L.latLng(90,180);return 90===t.natrval.lat?(999===t.natpole.lng&&(e.lng=180),e.lat=t.crval.lat):999===t.natpole.lng&&(e.lng=t.crval.lat<t.natrval.lat?180:0),e},_cpole:function(){var t=Math.PI/180,e=this.projparam,i=e.natpole.lng-e.natrval.lng,a=Math.cos(i*t),o=Math.sin(i*t),n=Math.cos(e.natrval.lat*t),s=Math.sin(e.natrval.lat*t),l=Math.cos(e.crval.lat*t),r=Math.sin(e.crval.lat*t),c=Math.atan2(s,n*a)/t,h=Math.acos(r/Math.sqrt(1-n*n*o*o))/t,p=c+h,d=c-h;-180>p?p+=360:p>180&&(p-=360),-180>d?d+=360:d>180&&(d-=360),c=p>90?d:-90>d?p:Math.abs(p-e.natpole.lat)<Math.abs(d-e.natpole.lat)?p:d;var u=90===Math.abs(e.crval.lat)?e.crval.lng:90===c?e.crval.lng+e.natpole.lng-e.natrval.lng-180:-90===c?e.crval.lng-e.natpole.lng+e.natrval.lng:e.crval.lng-Math.atan2(o*n/l,(s-Math.sin(c*t)*r)/(Math.cos(c*t)*l))/t;return L.latLng(c,u)},_phiThetaToRADec:function(t){var e=this.projparam,i=Math.PI/180,a=180/Math.PI,o=t.lat*i,n=Math.cos(o),s=Math.sin(o),l=e.cpole.lat*i,r=Math.cos(l),c=Math.sin(l),h=(t.lng-e.natpole.lng)*i,p=Math.cos(h),d=s*c+n*r*p;return d>1?d=1:-1>d&&(d=-1),L.latLng(Math.asin(d)*a,e.cpole.lng+Math.atan2(-n*Math.sin(h),s*r-n*c*p)*a)},_raDecToPhiTheta:function(t){var e=this.projparam,i=Math.PI/180,a=180/Math.PI,o=(t.lng-e.cpole.lng)*i,n=Math.cos(o),s=Math.sin(o),l=t.lat*i,r=Math.cos(l),c=Math.sin(l),h=e.cpole.lat*i,p=Math.cos(h),d=Math.sin(h),u=c*d+r*p*n,m=L.latLng(Math.asin(u>1?1:-1>u?-1:u)*a,e.natpole.lng+Math.atan2(-r*s,c*p-r*d*n)*a);return m.lng>180?m.lng-=360:m.lng<-180&&(m.lng+=360),m},_pixToRed:function(t){var e=this.projparam,i=e.cd,a=t.subtract(e.crpix);return L.point(a.x*i[0][0]+a.y*i[0][1],a.x*i[1][0]+a.y*i[1][1])},_redToPix:function(t){var e=this.projparam,i=e.cdinv;return L.point(t.x*i[0][0]+t.y*i[0][1],t.x*i[1][0]+t.y*i[1][1]).add(e.crpix)},_invertCD:function(t){var e=1/(t[0][0]*t[1][1]-t[0][1]*t[1][0]);return[[t[1][1]*e,-t[0][1]*e],[-t[1][0]*e,t[0][0]*e]]}}),L.Projection.WCS.PIX=L.Projection.WCS.extend({code:"PIX",_paramInit:function(t){this.projparam=t,t.cdinv=this._invertCD(t.cd),t.cpole=t.crval,this.bounds=L.bounds([.5,this.projparam.naxis.y-.5],[this.projparam.naxis.x-.5,.5])},project:function(t){return L.point(t.lng,t.lat)},unproject:function(t){return L.latLng(t.y,t.x)}}),L.Projection.WCS.zenithal=L.Projection.WCS.extend({_paramInit:function(t){this.projparam=t,t.cdinv=this._invertCD(t.cd),t.natrval=L.latLng(90,0),t.natpole=this._natpole(),t.cpole=this._cpole()},_redToPhiR:function(t){return L.latLng(Math.sqrt(t.x*t.x+t.y*t.y),180*Math.atan2(t.x,-t.y)/Math.PI)},_phiRToRed:function(t){var e=Math.PI/180,i=t.lng*e;return new L.Point(t.lat*Math.sin(i),-t.lat*Math.cos(i))}}),L.Projection.WCS.TAN=L.Projection.WCS.zenithal.extend({code:"TAN",_rToTheta:function(t){return 180*Math.atan2(180,Math.PI*t)/Math.PI},_thetaToR:function(t){return 180*Math.tan((90-t)*Math.PI/180)/Math.PI}}),L.Projection.WCS.ZEA=L.Projection.WCS.zenithal.extend({code:"ZEA",_rToTheta:function(t){var e=t*Math.PI/360;return Math.abs(e)<1?90-180*2*Math.asin(e)/Math.PI:90},_thetaToR:function(t){return 360*Math.sin((90-t)*Math.PI/360)/Math.PI}}),L.Projection.WCS.cylindrical=L.Projection.WCS.extend({_paramInit:function(t){Math.PI/180,this.projparam=t,t.cdinv=this._invertCD(t.cd),t.lambda=t.pv[1][1],0===t.lambda&&(t.lambda=1),t.natrval=L.latLng(0,0),t.natpole=this._natpole(),t.cpole=this._cpole()},_rToTheta:function(t){return t},_thetaToR:function(t){return t}}),L.Projection.WCS.CAR=L.Projection.WCS.cylindrical.extend({_redToPhiR:function(t){return L.latLng(t.y,t.x)},_phiRToRed:function(t){return L.point(t.lng,t.lat)}}),L.Projection.WCS.CEA=L.Projection.WCS.cylindrical.extend({_redToPhiR:function(t){var e=Math.PI/180,i=t.y*this.projparam.lambda*e;return L.latLng(i>-1?1>i?Math.asin(i)/e:90:-90,t.x)},_phiRToRed:function(t){var e=Math.PI/180;return L.point(t.lng,Math.sin(t.lat*e)/(this.projparam.lambda*e))}}),L.Projection.WCS.conical=L.Projection.WCS.extend({_redToPhiR:function(t){var e=Math.PI/180,i=this.projparam,a=i.y0-t.y,o=i.sthetaA*Math.sqrt(t.x*t.x+a*a);return L.latLng(o,Math.atan2(t.x/o,a/o)/i.c/e)},_phiRToRed:function(t){var e=Math.PI/180,i=this.projparam.c*t.lng*e;return L.point(t.lat*Math.sin(i),-t.lat*Math.cos(i)+this.projparam.y0)}}),L.Projection.WCS.COE=L.Projection.WCS.conical.extend({_paramInit:function(t){var e=Math.PI/180;this.projparam=t,t.cdinv=this._invertCD(t.cd),t.thetaA=t.pv[1][1],t.eta=t.pv[1][2],t.sthetaA=t.thetaA>=0?1:-1;var i=t.thetaA-t.eta,a=t.thetaA+t.eta,o=Math.sin(i*e),n=Math.sin(a*e);t.gamma=o+n,t.s1s2p1=o*n+1,t.c=t.gamma/2,t.y0=2/t.gamma*Math.sqrt(t.s1s2p1-t.gamma*Math.sin(t.thetaA*e))/e,t.natrval=L.latLng(t.thetaA,0),t.natpole=this._natpole(),t.cpole=this._cpole()},_rToTheta:function(t){var e=Math.PI/180,i=this.projparam.gamma,a=this.projparam.s1s2p1/i-i*t*t*e*e/4;return-1>a?a=-1:a>1&&(a=1),Math.asin(a)/e},_thetaToR:function(t){var e=Math.PI/180,i=this.projparam.gamma;return 2/i*Math.sqrt(this.projparam.s1s2p1-i*Math.sin(t*e))/e}}),L.CRS.WCS=L.extend({},L.CRS,{code:"WCS",options:{nzoom:9,tileSize:[256,256],nativeCelsys:!1},defaultparam:{ctype:{x:"PIXEL",y:"PIXEL"},naxis:[256,256],crpix:[129,129],crval:[0,0],cd:[[1,0],[0,1]],natrval:[90,0],natpole:[90,999],pv:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},initialize:function(t,e){e=L.setOptions(this,e);var i=this.defaultparam;switch(this.tileSize=L.point(e.tileSize),this.nzoom=e.nzoom,this.ctype={x:i.ctype.x,y:i.ctype.y},this.naxis=L.point(i.naxis,!0),this.projparam=new this._paramInit(i),t&&this._readWCS(t),this._paramInit(e,this.projparam),this.ctype.x.substr(5,3)){case"ZEA":this.projection=new L.Projection.WCS.ZEA,this.pixelFlag=!1,this.infinite=!0;break;case"TAN":this.projection=new L.Projection.WCS.TAN,this.pixelFlag=!1,this.infinite=!0;break;case"CAR":this.projection=new L.Projection.WCS.CAR,this.pixelFlag=!1,this.infinite=!0;break;case"CEA":this.projection=new L.Projection.WCS.CEA,this.pixelFlag=!1,this.infinite=!0;break;case"COE":this.projection=new L.Projection.WCS.COE,this.pixelFlag=!1,this.infinite=!0;break;default:this.projection=new L.Projection.WCS.PIX,this.pixelFlag=!0,this.infinite=!1,this.options.crval||(this.projparam.crval=L.latLng((this.naxis.y+1)/2,(this.naxis.x+1)/2)),this.wrapLng=[.5,this.naxis.x-.5],this.wrapLat=[this.naxis.y-.5,.5]}if(!this.pixelFlag){switch(this.ctype.x.substr(0,1)){case"G":this.celsyscode="galactic";break;case"E":this.celsyscode="ecliptic";break;case"S":this.celsyscode="supergalactic";break;default:this.celsyscode="equatorial"}"equatorial"!==this.celsyscode&&(this.projparam.celsysmat=this._celsysmatInit(this.celsyscode),this.projection.celsysToEq=this.celsysToEq,this.projection.eqToCelsys=this.eqToCelsys,this.forceNativeCelsys=this.options.nativeCelsys===!0,this.projection.celsysflag=!this.forceNativeCelsys)}this.transformation=new L.Transformation(1,-.5,-1,this.naxis.y+.5),this.projection._paramInit(this.projparam),this.code+=":"+this.projection.code},celsysToEq:function(t){var e=this.projparam.celsysmat,i=Math.PI/180,a=180/Math.PI,o=t.lng*i-e[1],n=t.lat*i,s=Math.sin(n),l=Math.cos(n)*e[2],r=s*e[3]-l*Math.cos(o);return L.latLng(Math.asin(r)*a,((Math.atan2(l*Math.sin(o),s-r*e[3])+e[0])*a+360)%360)},eqToCelsys:function(t){var e=this.projparam.celsysmat,i=Math.PI/180,a=180/Math.PI,o=t.lng*i-e[0],n=Math.sin(t.lat*i),s=Math.cos(t.lat*i)*e[2],l=n*e[3]+s*Math.cos(o);return L.latLng(Math.asin(l)*a,((Math.atan2(s*Math.sin(o),l*e[3]-n)+e[1])*a+360)%360)},scale:function(t){return Math.pow(2,t-this.nzoom+1)},zoom:function(t){return Math.log(t)/Math.LN2+this.nzoom-1},rawPixelScale:function(t){var e=this.projection.project(t),i=this.projection.unproject(e.add([10,0])),a=this.projection.unproject(e.add([0,10])),o=i.lng-t.lng,n=a.lng-t.lng;return o>180?o-=360:-180>o&&(o+=360),n>180?n-=360:-180>n&&(n+=360),.1*Math.sqrt(Math.abs(o*(a.lat-t.lat)-n*(i.lat-t.lat))*Math.cos(t.lat*Math.PI/180))},pixelScale:function(t,e){return this.rawPixelScale(e)/this.scale(t)},fovToZoom:function(t,e,i){var a=this.rawPixelScale(i),o=t.getSize();return a>e&&(e=a),a*=Math.sqrt(o.x*o.x+o.y*o.y),e>0?this.zoom(a/e):this.nzoom-1},zoomToFov:function(t,e,i){var a=t.getSize(),o=this.rawPixelScale(i)*Math.sqrt(a.x*a.x+a.y*a.y),n=this.scale(e);return n>0?o/n:o},distance:function(t,e){var i=Math.PI/180,a=t.lat*i,o=e.lat*i,n=Math.sin(a)*Math.sin(o)+Math.cos(a)*Math.cos(o)*Math.cos((e.lng-t.lng)*i);return 180/Math.PI*Math.acos(Math.min(n,1))},parseCoords:function(t,e){var i;if(i=e?/J\s(\d+\.?\d*)\s*,?\s*\+?(-?\d+\.?\d*)/g.exec(t):/(-?\d+\.?\d*)\s*,\s*\+?(-?\d+\.?\d*)/g.exec(t),i&&i.length>=3){var a=L.latLng(Number(i[2]),Number(i[1]));return this.forceNativeCelsys&&(a=this.eqToCelsys(a)),a}return void 0},_paramInit:function(t,e){e||(e=this),t.naxis&&(e.naxis=L.point(t.naxis)),t.crval&&(e.crval=e.cpole=L.latLng(t.crval)),t.crpix&&(e.crpix=L.point(t.crpix)),t.cd&&(e.cd=[[t.cd[0][0],t.cd[0][1]],[t.cd[1][0],t.cd[1][1]]]),t.natrval&&(e.natrval=L.latLng(t.natrval)),t.natpole&&(e.natpole=L.latLng(t.natpole)),t.pv&&(e.pv=[],e.pv[0]=t.pv[0].slice(),e.pv[1]=t.pv[1].slice())},_celsysmatInit:function(t){var e,i,a=Math.PI/180,o=[];switch(t){case"galactic":e=L.latLng(-28.93617242,266.40499625),i=L.latLng(27.1282512,192.85948123);break;case"ecliptic":e=L.latLng(0,0),i=L.latLng(66.99111111,273.85261111);break;case"supergalactic":e=L.latLng(59.52315,42.29235),i=L.latLng(15.7048,283.7514);break;default:e=L.latLng(0,0),i=L.latLng(0,0)}return o[0]=i.lng*a,o[1]=Math.asin(Math.cos(e.lat*a)*Math.sin((i.lng-e.lng)*a)),o[2]=Math.cos(i.lat*a),o[3]=Math.sin(i.lat*a),o},_readWCS:function(t){var e,i=L.IIPUtils.readFITSKey,a=this.projparam;(e=i("CTYPE1",t))&&(this.ctype.x=e),(e=i("CTYPE2",t))&&(this.ctype.y=e),(e=i("NAXIS1",t))&&(a.naxis.x=this.naxis.x=parseInt(e,10)),(e=i("NAXIS2",t))&&(a.naxis.y=this.naxis.y=parseInt(e,10)),(e=i("CRPIX1",t))&&(a.crpix.x=parseFloat(e,10)),(e=i("CRPIX2",t))&&(a.crpix.y=parseFloat(e,10)),(e=i("CRVAL1",t))&&(a.crval.lng=parseFloat(e,10)),(e=i("CRVAL2",t))&&(a.crval.lat=parseFloat(e,10)),(e=i("LONPOLE",t))&&(a.natpole.lng=parseFloat(e,10)),(e=i("LATPOLE",t))&&(a.natpol.lat=parseFloat(e,10)),(e=i("CD1_1",t))&&(a.cd[0][0]=parseFloat(e,10)),(e=i("CD1_2",t))&&(a.cd[0][1]=parseFloat(e,10)),(e=i("CD2_1",t))&&(a.cd[1][0]=parseFloat(e,10)),(e=i("CD2_2",t))&&(a.cd[1][1]=parseFloat(e,10));for(var o=0;2>o;o++)for(var n=0;20>n;n++)(e=i("PV"+(o+1)+"_"+n,t))&&(a.pv[o][n]=parseFloat(e,10))},_deltaLng:function(t,e){var i=t.lng-e.lng;return i>180?i-360:-180>i?i+360:i}}),L.CRS.WCS=L.Class.extend(L.CRS.WCS),L.CRS.wcs=function(t){return new L.CRS.WCS(t)},L.IIPUtils={REG_PDEC:"(\\d+\\.\\d*)",REG_FLOAT:"([-+]?[0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",requestURL:function(t,e,i,a,o){var n;if(window.XMLHttpRequest)n=new XMLHttpRequest;else if(window.ActiveXObject)try{n=new ActiveXObject("Msxml2.XMLHTTP")}catch(s){try{n=new ActiveXObject("Microsoft.XMLHTTP")}catch(s){}}return n?(o&&(n.timeout=1e3*o,n.ontimeout=function(){alert("Time out while "+e)}),n.open("GET",t),a&&a.options.credentials&&(n.withCredentials=!0),a&&"csrftoken"===a.options.authenticate&&n.setRequestHeader("X-CSRFToken",this.getCookie("csrftoken")),i&&(n.onreadystatechange=function(){i(a,n)}),n.send(),void 0):(alert("Giving up: Cannot create an XMLHTTP instance for "+e),!1)},parseURL:function(t){var e={};return t.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(t,i,a,o){e[i]=o}),e},updateURL:function(t,e,i){var a=new RegExp("([?&])"+e+"=.*?(&|$)","i"),o=-1!==t.indexOf("?")?"&":"?";return t.match(a)?t.replace(a,"$1"+e+"="+i+"$2"):t+o+e+"="+i},checkDomain:function(t){return 0===t.indexOf("//")&&(t=location.protocol+t),t.toLowerCase().replace(/([a-z])?:\/\//,"$1").split("/")[0]},isExternal:function(t){return(t.indexOf(":")>-1||t.indexOf("//")>-1)&&this.checkDomain(location.href)!==this.checkDomain(t)},copyToClipboard:function(t){if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var e=document.createElement("textarea");e.textContent=t,e.style.position="fixed",document.body.appendChild(e),e.select();try{return document.execCommand("copy")}catch(i){return console.warn("Copy to clipboard failed.",i),!1}finally{document.body.removeChild(e)}}},flashElement:function(t){L.DomUtil.addClass(t,"leaflet-control-flash"),setTimeout(function(){L.DomUtil.removeClass(t,"leaflet-control-flash")},400)},readFITSKey:function(t,e){var i=t.trim().toUpperCase().substr(0,8),a=8-i.length,o=new RegExp(i+(a>0?"\\ {"+a.toString()+"}":"")+"=\\ *(?:'((?:\\ *[^'\\ ]+)*)\\ *'|([-+]?[0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?))"),n=o.exec(e);return n?n[1]?n[1]:n[2]:null},distance:function(t,e){var i=Math.PI/180,a=t.lat*i,o=e.lat*i,n=o-a,s=(e.lng-t.lng)*i,l=Math.sin(n/2),r=Math.sin(s/2),c=l*l+r*r*Math.cos(a)*Math.cos(o);return 360*Math.atan2(Math.sqrt(c),Math.sqrt(1-c))/Math.PI},latLngToHMSDMS:function(t){var e=(t.lng+360)/360;e=24*(e-Math.floor(e));var i=Math.floor(e),a=60*(e-i),o=Math.floor(a),n=60*(a-o);n>=60&&(o++,n=0),60===o&&(i++,o=0);var s=(10>i?"0":"")+i.toString()+":"+(10>o?"0":"")+o.toString()+":"+(10>n?"0":"")+n.toFixed(3),l=Math.abs(t.lat),r=t.lat<0?"-":"+",c=Math.floor(l);return a=60*(l-c),o=Math.floor(a),n=60*(a-o),n>=60&&(o++,n=0),60===o&&(i++,o=0),s+" "+r+(10>c?"0":"")+c.toString()+":"+(10>o?"0":"")+o.toString()+":"+(10>n?"0":"")+n.toFixed(2)},getCookie:function(t){for(var e=t+"=",i=document.cookie.split(";"),a=0;a<i.length;a++){for(var o=i[a];" "===o.charAt(0);)o=o.substring(1);if(0===o.indexOf(e))return o.substring(e.length,o.length)}return""}},L.TileLayer.IIP=L.TileLayer.extend({options:{title:"",crs:null,nativeCelsys:!1,center:!1,fov:!1,minZoom:0,maxZoom:null,maxNativeZoom:18,noWrap:!0,contrast:1,colorSat:1,gamma:1,cMap:"grey",invertCMap:!1,quality:90,mixingMode:"color",channelColors:[],channelLabels:[],channelLabelMatch:".*",channelUnits:[],minMaxValues:[],defaultChannel:0,credentials:!1},iipdefault:{contrast:1,gamma:1,cMap:"grey",invertCMap:!1,minValue:[],maxValue:[],channelColors:[[""],["#FFFFFF"],["#00BAFF","#FFBA00"],["#0000FF","#00FF00","#FF0000"],["#0000E0","#00BA88","#88BA00","#E00000"],["#0000CA","#007BA8","#00CA00","#A87B00","#CA0000"],["#0000BA","#00719B","#009B71","#719B00","#9B7100","#BA0000"]],quality:90},initialize:function(t,e){return this.type="tilelayer",this._url=t.replace(/\&.*$/g,""),e=L.setOptions(this,e),e.detectRetina&&L.Browser.retina&&e.maxZoom>0&&(e.tileSize=Math.floor(e.tileSize/2),e.zoomOffset++,e.minZoom=Math.max(0,e.minZoom),e.maxZoom--),"string"==typeof e.subdomains&&(e.subdomains=e.subdomains.split("")),this.iipTileSize={x:256,y:256},this.iipImageSize=[],this.iipImageSize[0]=this.iipTileSize,this.iipGridSize=[],this.iipGridSize[0]={x:1,y:1},this.iipBPP=8,this.iipMode=e.mixingMode,this.iipChannel=0,this.iipNChannel=1,this.iipMinZoom=e.minZoom,this.iipMaxZoom=e.maxZoom,this.iipContrast=e.contrast,this.iipColorSat=e.colorSat,this.iipGamma=e.gamma,this.iipCMap=e.cMap,this.iipInvertCMap=e.invertCMap,this.iipMinValue=[],this.iipMinValue[0]=0,this.iipMaxValue=[],this.iipMaxValue[0]=255,this.iipMix=[[]],this.iipRGB=[],this.iipChannelLabels=[],this.iipChannelFlags=[],this.iipChannelUnits=[],this.iipQuality=e.quality,this._title=e.title.length>0?e.title:this._url.match(/^.*\/(.*)\..*$/)[1],this.getIIPMetaData(this._url),L.Browser.android||this.on("tileunload",this._onTileRemove),this},getIIPMetaData:function(t){L.IIPUtils.requestURL(t+"&obj=IIP,1.0&obj=max-size&obj=tile-size"+"&obj=resolution-number&obj=bits-per-channel"+"&obj=min-max-sample-values&obj=subject","getting IIP metadata",this._parseMetadata,this)},_parseMetadata:function(t,e){if(4===e.readyState)if(200===e.status){var i=e.responseText,a=t._readIIPKey(i,"IIP",L.IIPUtils.REG_PDEC);a||alert("Error: Unexpected response from IIP server "+t._url.replace(/\?.*$/g,""));var o=t.options,n=t.iipdefault;a=t._readIIPKey(i,"Max-size","(\\d+)\\s+(\\d+)");var s={x:parseInt(a[1],10),y:parseInt(a[2],10)};a=t._readIIPKey(i,"Tile-size","(\\d+)\\s+(\\d+)"),t.iipTileSize={x:parseInt(a[1],10),y:parseInt(a[2],10)},o.tileSize=t.iipTileSize.x,a=t._readIIPKey(i,"Resolution-number","(\\d+)"),t.iipMaxZoom=parseInt(a[1],10)-1,t.iipMinZoom>o.minZoom&&(o.minZoom=t.iipMinZoom),o.maxZoom||(o.maxZoom=t.iipMaxZoom+6),o.maxNativeZoom=t.iipMaxZoom;for(var l=0;l<=t.iipMaxZoom;l++)t.iipImageSize[l]={x:Math.floor(s.x/Math.pow(2,t.iipMaxZoom-l)),y:Math.floor(s.y/Math.pow(2,t.iipMaxZoom-l))},t.iipGridSize[l]={x:Math.ceil(t.iipImageSize[l].x/t.iipTileSize.x),y:Math.ceil(t.iipImageSize[l].y/t.iipTileSize.y)};for(l=t.iipMaxZoom;l<=o.maxZoom;l++)t.iipGridSize[l]=t.iipGridSize[t.iipMaxZoom];a=t._readIIPKey(i,"Bits-per-channel","(\\d+)"),t.iipBPP=parseInt(a[1],10),t.iipGamma===t.iipdefault.gamma&&(t.iipGamma=t.iipBPP>=32?2.2:1),a=t._readIIPKey(i,"Min-Max-sample-values","\\s*(.*)");for(var r=a[1].split(/\s+/),c=t.iipNChannel=r.length/2,h=0,p=0;c>p;p++)n.minValue[p]=parseFloat(r[h++]),n.maxValue[p]=parseFloat(r[h++]);var d=o.minMaxValues;if(d.length)for(p=0;c>p;p++)void 0!==d[p]&&d[p].length?(t.iipMinValue[p]=d[p][0],t.iipMaxValue[p]=d[p][1]):(t.iipMinValue[p]=n.minValue[p],t.iipMaxValue[p]=n.maxValue[p]);else for(p=0;c>p;p++)t.iipMinValue[p]=n.minValue[p],t.iipMaxValue[p]=n.maxValue[p];t.iipChannel=o.defaultChannel;var u,m,_=o.channelLabels,g=_.length,f=t.iipChannelLabels,v=o.channelUnits,x=v.length,C=t.iipChannelUnits,y=L.IIPUtils.readFITSKey;for(p=0;c>p;p++)g>p?f[p]=_[p]:(u=(p+1).toString(),m=y("CHAN"+(9>p?"000":99>p?"00":999>p?"0":"")+u,i),f[p]=m?m:"Channel #"+u);for(p=0;x>p;p++)C[p]=v[p];for(p=x;c>p;p++)C[p]="ADUs";var M=0,b=t.iipMix,S=o.channelColors,D=t.iipRGB,I=new RegExp(o.channelLabelMatch),P=0,T=t.iipChannelFlags;for(P=0,p=0;c>p;p++)T[p]=I.test(f[p]),T[p]&&P++;for(P>=n.channelColors.length&&(P=n.channelColors.length-1),p=0;c>p;p++)b[p]=[],D[p]=S.length&&S[p]&&3===S[p].length?L.rgb(S[p][0],S[p][1],S[p][2]):L.rgb(0,0,0),0===S.length&&T[p]&&P>M&&(D[p]=L.rgb(n.channelColors[P][M++])),t.rgbToMix(p);o.bounds&&(o.bounds=L.latLngBounds(o.bounds)),t.wcs=o.crs?o.crs:new L.CRS.WCS(i,{nativeCelsys:t.options.nativeCelsys,nzoom:t.iipMaxZoom+1,tileSize:t.iipTileSize}),t.iipMetaReady=!0,t.fire("metaload")}else alert("There was a problem with the IIP metadata request.")},rgbToMix:function(t,e){e?this.iipRGB[t]=e.clone():e=this.iipRGB[t];var i=this._gammaCorr(e.r),a=this._gammaCorr(e.g),o=this._gammaCorr(e.b),n=(i+a+o)/3,s=this.iipColorSat/3;this.iipMix[t][0]=n+s*(2*i-a-o),this.iipMix[t][1]=n+s*(2*a-i-o),this.iipMix[t][2]=n+s*(2*o-i-a)},updateMono:function(){this.iipMode="mono"},updateMix:function(){var t=this.iipNChannel;this.iipMode="color";for(var e=0;t>e;e++)this.rgbToMix(e,this.iipRGB[e])},_gammaCorr:function(t){return t>0?Math.pow(t,this.iipGamma):0},_readIIPKey:function(t,e,i){var a=new RegExp(e+":"+i);return a.exec(t)},addTo:function(t){return this.iipMetaReady?this._addToMap(t):this.once("metaload",function(){this._addToMap(t)},this),this},_addToMap:function(t){var e,i=this.wcs,a=t.options.crs,o=t._prevcrs,n=t._loaded,s=t.options.center?t.options.center:i.projparam.crval;if(n&&(a._prevLatLng=t.getCenter(),a._prevZoom=t.getZoom()),t._prevcrs=t.options.crs=i,L.TileLayer.prototype.addTo.call(this,t),o&&i!==a&&n&&i.pixelFlag===a.pixelFlag){s=a._prevLatLng,e=a._prevZoom;var l=o.pixelScale(e,s),r=i.pixelScale(e,s);l>1e-20&&r>1e-20&&(e+=Math.round(Math.LOG2E*Math.log(r/l)))}else if(i._prevLatLng)s=i._prevLatLng,e=i._prevZoom;else if(this.options.center){var c=i.parseCoords(this.options.center);c?(this.options.fov&&(e=i.fovToZoom(t,this.options.fov,c)),t.setView(c,e,{reset:!0,animate:!1})):L.IIPUtils.requestURL("http://cdsweb.u-strasbg.fr/cgi-bin/nph-sesame/-oI/A?"+this.options.center,"getting coordinates for "+this.options.center,function(a,o){if(4===o.readyState)if(200===o.status){var n=o.responseText,l=i.parseCoords(n,!0);l?(a.options.fov&&(e=i.fovToZoom(t,a.options.fov,l)),t.setView(l,e,{reset:!0,animate:!1})):(t.setView(s,e,{reset:!0,animate:!1}),alert(n+": Unknown location"))}else t.setView(s,e,{reset:!0,animate:!1}),alert("There was a problem with the request to the Sesame service at CDS")},this,10)}else t.setView(s,e,{reset:!0,animate:!1})},_getTileSizeFac:function(){var t=this._map,e=this._tileZoom,i=this.options.maxNativeZoom;return i&&e>i?Math.round(t.getZoomScale(e)/t.getZoomScale(i)):1},_isValidTile:function(t){var e=this._map.options.crs;if(!e.infinite){var i=this._globalTileRange;if(!e.wrapLng&&(t.x<i.min.x||t.x>i.max.x)||!e.wrapLat&&(t.y<i.min.y||t.y>i.max.y))return!1}var a=this._getZoomForUrl(),o=t.clone();if(this._wrapCoords(o),o.x<0||o.x>=this.iipGridSize[a].x||o.y<0||o.y>=this.iipGridSize[a].y)return!1;if(!this.options.bounds)return!0;var n=this._tileCoordsToBounds(t);return L.latLngBounds(this.options.bounds).intersects(n)},createTile:function(t,e){var i=L.TileLayer.prototype.createTile.call(this,t,e);return i.coords=t,i},getTileUrl:function(t){var e=this._url,i=this._getZoomForUrl();this.iipCMap!==this.iipdefault.cMap&&(e+="&CMP="+this.iipCMap),this.iipInvertCMap!==this.iipdefault.invertCMap&&(e+="&INV"),this.iipContrast!==this.iipdefault.contrast&&(e+="&CNT="+this.iipContrast.toString()),this.iipGamma!==this.iipdefault.gamma&&(e+="&GAM="+(1/this.iipGamma).toFixed(4));for(var a=0;a<this.iipNChannel;a++)(this.iipMinValue[a]!==this.iipdefault.minValue[a]||this.iipMaxValue[a]!==this.iipdefault.maxValue[a])&&(e+="&MINMAX="+(a+1).toString()+":"+this.iipMinValue[a].toString()+","+this.iipMaxValue[a].toString());var o,n,s=this.iipNChannel,l=this.iipMix;if(e+="&CTW=","color"===this.iipMode)for(n=0;3>n;n++)for(n&&(e+=";"),e+=l[0][n].toString(),o=1;s>o;o++)void 0!==l[o][n]&&(e+=","+l[o][n].toString());else{var r=this.iipChannel;for(r>=s&&(r=0),s>r&&(s=r+1),n=0;3>n;n++)for(n&&(e+=";"),e+=0===r?"1":"0",o=1;s>o;o++)e+=","+(r===o?"1":"0")}return this.iipQuality!==this.iipdefault.quality&&(e+="&QLT="+this.iipQuality.toString()),e+"&JTL="+i.toString()+","+(t.x+this.iipGridSize[i].x*t.y).toString()},_initTile:function(t){L.DomUtil.addClass(t,"leaflet-tile");var e=this._getTileSizeFac();e>1&&(L.Browser.ie?t.style.msInterpolationMode="nearest-neighbor":t.style.imageRendering=L.Browser.chrome?"pixelated":L.Browser.gecko?"-moz-crisp-edges":"-webkit-optimize-contrast");var i=t.coords,a=i.z;a>this.iipMaxZoom&&(a=this.iipMaxZoom);var o=i.x+1===this.iipGridSize[a].x?this.iipImageSize[a].x%this.iipTileSize.x:this.iipTileSize.x,n=i.y+1===this.iipGridSize[a].y?this.iipImageSize[a].y%this.iipTileSize.y:this.iipTileSize.y;0===o&&(o=this.iipTileSize.x),0===n&&(n=this.iipTileSize.y),o*=e,n*=e,t.style.width=o+"px",t.style.height=n+"px",t.onselectstart=L.Util.falseFn,t.onmousemove=L.Util.falseFn,L.Browser.ielt9&&this.options.opacity<1&&L.DomUtil.setOpacity(t,this.options.opacity),L.Browser.android&&!L.Browser.android23&&(t.style.WebkitBackfaceVisibility="hidden")}}),L.tileLayer.iip=function(t,e){return new L.TileLayer.IIP(t,e)},L.RGB=function(t,e,i){this.r=t,this.g=e,this.b=i},L.RGB.prototype={clone:function(){return new L.RGB(this.r,this.g,this.b)},toStr:function(){var t=Math.round(255*this.r),e=Math.round(255*this.g),i=Math.round(255*this.b);return 0>t?t=0:t>255&&(t=255),0>e?e=0:e>255&&(e=255),0>i?i=0:i>255&&(i=255),"#"+((1<<24)+(t<<16)+(e<<8)+i).toString(16).slice(1)},isOn:function(){return this.r>0||this.g>0||this.b>0?!0:!1}},L.rgb=function(t,e,i){if(t instanceof L.RGB)return t;if("string"==typeof t){var a=parseInt("0x"+t.slice(1),16);return new L.RGB((255&a>>16)/255,(255&a>>8)/255,(255&a)/255)}return L.Util.isArray(t)?new L.RGB(t[0],t[1],t[2]):void 0===t||null===t?t:new L.RGB(t,e,i)},L.EllipseMarker=L.Path.extend({CANVAS:!0,SVG:!1,options:{fill:!0,majAxis:10,minAxis:10,posAngle:0},initialize:function(t,e){L.setOptions(this,e),this._majAxis=this.options.majAxis,this._minAxis=this.options.majAxis,this._posAngle=this.options.posAngle,this._latlng=L.latLng(t);var i=Math.PI/180,a=Math.cos(this._posAngle*i),o=Math.sin(this._posAngle*i),n=a*a,s=o*o,l=this._majAxis*this._majAxis,r=this._minAxis*this._minAxis,c=l*n+r*s,h=l*s+r*n,p=(l-r)*a*o,d=c*h-p*p;this._limX=Math.sqrt(c),this._limY=Math.sqrt(h),0>=d&&(c+=1,h+=1,d=c*h-p*p),this._cXX=h/d,this._cYY=c/d,this._cXY=-2*p/d},setLatLng:function(t){return this._latlng=L.latLng(t),this.redraw(),this.fire("move",{latlng:this._latlng})},getLatLng:function(){return this._latlng},setParams:function(t){return this.options.majAxis=this._majAxis=t.majAxis,this.options.minAxis=this._minAxis=t.minAxis,this.options.posAngle=this._posAngle=t.posAngle,this.redraw()},getParams:function(){var t;return t.majAxis=this._majAxis,t.minAxis=this._minAxis,t.posAngle=this._posAngle,t},setStyle:L.Path.prototype.setStyle,_project:function(){this._point=this._map.latLngToLayerPoint(this._latlng),this._updateBounds()},_updateBounds:function(){var t=this._clickTolerance(),e=[this._limX+t,this._limY+t];this._pxBounds=new L.Bounds(this._point.subtract(e),this._point.add(e))},_update:function(){this._map&&this._updatePath()},_updatePath:function(){this._renderer._updateEllipse(this)},_empty:function(){return this._majAxis&&!this._renderer._bounds.intersects(this._pxBounds)},_containsPoint:function(t){var e=t.subtract(this._point),i=this._clickTolerance(),a=Math.abs(e.x)-i,o=Math.abs(e.y)-i;return this._cXX*(a>0?a*a:0)+this._cYY*(o>0?o*o:0)+this._cXY*e.x*e.y<=1}}),L.ellipseMarker=function(t,e){return new L.EllipseMarker(t,e)},L.Canvas.include({_updateEllipse:function(t){if(!t._empty()){var e=t._point,i=this._ctx,a=t._minAxis,o=t._majAxis/t._minAxis;i.save(),i.translate(e.x,e.y),i.rotate(t._posAngle*Math.PI/180),i.scale(1,o),i.beginPath(),i.arc(0,0,a,0,2*Math.PI,!1),i.restore(),this._fillStroke(i,t)}}}),L.SVG.include({_updateEllipse:function(t){var e=Math.PI/180,i=t._point,a=t._minAxis,o=t._majAxis,n=a*Math.cos(t._posAngle*e),s=a*Math.sin(t._posAngle*e),l="a"+a+","+o+" "+t._posAngle+" 1,0 ",r=t._empty()?"M0 0":"M"+(i.x-n)+","+(i.y-s)+l+2*n+","+2*s+" "+l+2*-n+","+2*-s+" ";this._setPath(t,r)}}),L.Ellipse=L.EllipseMarker.extend({options:{fill:!0},initialize:function(t,e){L.setOptions(this,e);var i=Math.PI/180,a=Math.cos(this.options.posAngle*i),o=Math.sin(this.options.posAngle*i),n=a*a,s=o*o,l=this.options.majAxis*this.options.majAxis,r=this.options.minAxis*this.options.minAxis;this._latlng=L.latLng(t),this._mLat2=l*n+r*s,this._mLng2=l*s+r*n,this._mLatLng=(l-r)*a*o},getBounds:function(){var t=[this._limX,this._limY];return new L.LatLngBounds(this._map.layerPointToLatLng(this._point.subtract(t)),this._map.layerPointToLatLng(this._point.add(t)))},_project:function(){var t=this._map,e=t.options.crs;if(this._point=t.latLngToLayerPoint(this._latlng),!this._majAxis1){var i=this._latlng.lng,a=this._latlng.lat,o=Math.PI/180,n=Math.cos(a*o),s=90>a?.001:-.001,l=e.project(this._latlng),r=e.project(L.latLng(a+s,i)).subtract(l),c=e.project(L.latLng(a,i+1*s/(n>s?n:s))).subtract(l),h=r.x/s,p=c.x/s,d=r.y/s,u=c.y/s,m=h*h*this._mLat2+p*p*this._mLng2+2*h*p*this._mLatLng,_=d*d*this._mLat2+u*u*this._mLng2+2*d*u*this._mLatLng,g=h*d*this._mLat2+p*u*this._mLng2+(h*u+p*d)*this._mLatLng,f=.5*(m+_),v=Math.sqrt(.25*(m-_)*(m-_)+g*g),x=m*_-g*g;this._majAxis=this._majAxis1=Math.sqrt(f+v),this._minAxis=this._minAxis1=f>v?Math.sqrt(f-v):0,this._posAngle=.5*Math.atan2(2*g,m-_)/o,this._limX=this._limX1=Math.sqrt(m),this._limY=this._limY1=Math.sqrt(_),0>=x&&(m+=1,_+=1,x=m*_-g*g),this._cXX1=_/x,this._cYY1=m/x,this._cXY1=-2*g/x}var C=e.scale(t._zoom),y=1/(C*C);this._majAxis=this._majAxis1*C,this._minAxis=this._minAxis1*C,this._limX=this._limX1*C,this._limY=this._limY1*C,this._cXX=this._cXX1*y,this._cYY=this._cYY1*y,this._cXY=this._cXY1*y,this._updateBounds()}}),L.ellipse=function(t,e){return new L.Ellipse(t,e)},L.Catalog={nmax:1e4,_csvToGeoJSON:function(t){var e=new RegExp("#|--|^$"),i=t.split("\n"),a={type:"FeatureCollection",features:[]};for(var o in i){var n=i[o];if(e.test(n)===!1){var s={type:"Feature",id:"",properties:{items:[]},geometry:{type:"Point",coordinates:[0,0]}},l=s.geometry,r=s.properties,c=n.split(/[,;\t]/);s.id=c[0],l.coordinates[0]=parseFloat(c[1]),l.coordinates[1]=parseFloat(c[2]);var h,p=c.slice(3);for(var d in p)h=parseFloat(p[d]),r.items.push(isNaN(h)?"--":h);a.features.push(s)}}return a},toGeoJSON:function(t){return this._csvToGeoJSON(t)},popup:function(t){var e="<div>";e+=this.objurl?'ID: <a href="'+L.Util.template(this.objurl,L.extend({ra:t.geometry.coordinates[0].toFixed(6),dec:t.geometry.coordinates[1].toFixed(6)}))+'" target="_blank">'+t.id+"</a></div>":"ID: "+t.id+"</div>",e+='<TABLE style="margin:auto;"><TBODY style="vertical-align:top;text-align:left;">';for(var i in this.properties)e+="<TR><TD>"+this.properties[i]+":</TD>"+"<TD>"+t.properties.items[i].toString()+" ",this.units[i]&&(e+=this.units[i]),e+="</TD></TR>";return e+="</TBODY></TABLE>"},draw:function(t,e){var i=t.properties.items[this.magindex?this.magindex:0];return L.circleMarker(e,{radius:i?this.maglim+5-i:8})},vizierURL:"http://vizier.u-strasbg.fr/viz-bin"},L.Catalog["2MASS"]=L.extend({},L.Catalog,{name:"2MASS",attribution:"2MASS All-Sky Catalog of Point Sources (Cutri et al. 2003)",color:"red",maglim:17,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=II/246&"+"-out=2MASS,RAJ2000,DEJ2000,Jmag,Hmag,Kmag&-out.meta=&"+"-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&"+"-out.max={nmax}",properties:["J","H","K"],units:["","",""],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=II/246&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.SDSS=L.extend({},L.Catalog,{name:"SDSS release 9",attribution:"SDSS Photometric Catalog, Release 9 (Adelman-McCarthy et al. 2012)",color:"yellow",maglim:25,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=V/139&"+"-out=SDSS9,RAJ2000,DEJ2000,umag,gmag,rmag,imag,zmag&-out.meta=&"+"-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-sort=imag&-out.max={nmax}",properties:["u","g","r","i","z"],units:["","","","",""],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=V/139/sdss9&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.PPMXL=L.extend({},L.Catalog,{name:"PPMXL",attribution:"PPM-Extended, positions and proper motions by Roeser et al. 2008",color:"green",maglim:20,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=I/317&"+"-out=PPMXL,RAJ2000,DEJ2000,Jmag,Hmag,Kmag,b1mag,b2mag,r1mag,r2mag,imag,pmRA,pmDE&-out.meta=&"+"-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["J","H","K","b<sub>1</sub>","b<sub>2</sub>","r<sub>1</sub>","r<sub>2</sub>","i","&#956;<sub>&#593;</sub> cos &#948;","&#956;<sub>&#948;</sub>"],units:["","","","","","","","","mas/yr","mas/yr"],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=I/317&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.Catalog.Abell=L.extend({},L.Catalog,{name:"Abell clusters",attribution:"Rich Clusters of Galaxies (Abell et al. 1989) ",color:"orange",maglim:30,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=VII/110A&"+"-out=ACO,_RAJ2000,_DEJ2000,m10,Rich,Dclass&-out.meta=&"+"-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["m<sub>10</sub>","Richness","D<sub>class</sub>"],units:["","",""],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=VII/110A&-c={ra},{dec},eq=J2000&-c.rs=0.2"}),L.Catalog.NVSS=L.extend({},L.Catalog,{name:"NVSS",attribution:"1.4GHz NRAO VLA Sky Survey (NVSS) (Condon et al. 1998)",color:"magenta",maglim:30,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=VIII/65/NVSS&"+"-out=NVSS,_RAJ2000,_DEJ2000,S1.4,MajAxis,MinAxis,PA&-out.meta=&"+"-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["S<sub>1.4GHz</sub>","Major axis","Minor axis","Position angle"],units:["mJy","&#8243;","&#8243;","&#176;"],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=VIII/65/NVSS&-c={ra},{dec},eq=J2000&-c.rs=0.2",draw:function(t,e){return L.ellipse(e,{majAxis:t.properties.items[1]/7200,minAxis:t.properties.items[2]/7200,posAngle:"--"===t.properties.items[3]?90:90-t.properties.items[3]})
}}),L.Catalog.FIRST=L.extend({},L.Catalog,{name:"FIRST",attribution:"The FIRST Survey Catalog (Helfand et al. 2015)",color:"blue",maglim:30,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=VIII/92/first14&"+"-out=FIRST,_RAJ2000,_DEJ2000,Fpeak,fMaj,fMin,fPA&-out.meta=&"+"-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["F<sub>peak</sub>(1.4GHz)","Major axis FWHM","Minor axis FWHM","Position angle"],units:["mJy","&#8243;","&#8243;","&#176;"],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=VIII/92/first14&-c={ra},{dec},eq=J2000&-c.rs=0.2",draw:function(t,e){return L.ellipse(e,{majAxis:t.properties.items[1]/7200,minAxis:t.properties.items[2]/7200,posAngle:"--"===t.properties.items[3]?90:90-t.properties.items[3]})}}),L.Catalog.AllWISE=L.extend({},L.Catalog,{name:"AllWISE",attribution:"AllWISE Data Release (Cutri et al. 2013)",color:"red",maglim:18,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=II/328/allwise&"+"-out=AllWISE,_RAJ2000,_DEJ2000,W1mag,W2mag,W3mag,W4mag&-out.meta=&"+"-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["W1<sub>mag</sub> (3.4µm)","W2<sub>mag</sub> (4.6µm)","W3<sub>mag</sub> (12µm)","W4<sub>mag</sub> (22µm)"],units:["","","",""],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=II/328/allwise&-c={ra},{dec},eq=J2000&-c.rs=0.2"}),L.Catalog.GALEX_AIS=L.extend({},L.Catalog,{name:"GALEX AIS",attribution:"GALEX catalogs of UV sources: All-sky Imaging Survey (Bianchi et al. 2011)",color:"magenta",maglim:21,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=II/312/ais&"+"-out=objid,_RAJ2000,_DEJ2000,FUV,NUV&-out.meta=&"+"-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["FUV<sub>AB</sub>","NUV<sub>AB</sub>"],units:["",""],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=II/312/ais&-c={ra},{dec},eq=J2000&-c.rs=0.2"}),L.Catalog.GAIA_DR1=L.extend({},L.Catalog,{name:"Gaia DR1",attribution:"First Gaia Data Release (2016)",color:"green",maglim:20,service:"Vizier@CDS",regionType:"box",url:L.Catalog.vizierURL+"/asu-tsv?&-mime=csv&-source=I/337&"+"-out=Source,RA_ICRS,DE_ICRS,<Gmag>,pmRA,pmDE&-out.meta=&"+"-c.eq={sys}&-c={lng},{lat}&-c.bd={dlng},{dlat}&-out.max={nmax}",properties:["G","&#956;<sub>&#593;</sub> cos &#948;","&#956;<sub>&#948;</sub>"],units:["","mas/yr","mas/yr"],objurl:L.Catalog.vizierURL+"/VizieR-5?-source=I/337&-c={ra},{dec},eq=J2000&-c.rs=0.01"}),L.FlipSwitch=L.Evented.extend({options:{checked:!1,title:"Click to switch",className:"leaflet-flipswitch",id:"leaflet-flipswitch"},initialize:function(t,e){e=L.setOptions(this,e);var i=e.className,a=L.DomUtil.create("div",i,t),o=this._input=L.DomUtil.create("input",i,a),n=L.DomUtil.create("label",i,a);return o.type="checkbox",o.name=e.className,o.checked=e.checked,n.htmlFor=o.id=e.id,e.title&&(n.title=e.title),L.DomUtil.create("span",i+"-inner",n),L.DomUtil.create("span",i+"-button",n),L.DomEvent.disableClickPropagation(a).disableScrollPropagation(a),L.DomEvent.on(o,"change",function(){this.fire("change")},this),a},value:function(t){return void 0===t?this._input.checked:(this._input.checked=t?!0:!1,this)}}),L.flipswitch=function(t,e){return new L.FlipSwitch(t,e)},L.SpinBox=L.Evented.extend({options:{dmin:void 0,dmax:void 0,step:void 0,initValue:void 0,repButton:!0,clickEvent:"click",instantUpdate:!1,title:"Enter value",className:"leaflet-spinbox"},initialize:function(t,e){e=L.setOptions(this,e);var i=this,a=this._drag={startEvent:"touchstart mousedown",stopEvent:"touchend mouseup mouseout touchcancel",move:!1,start:!1,end:!1,pos:!1,target:!1,delta:!1,tmp:!1,cnt:0,step:e.step,prec:this._prec(e.step)},o=this._wrap=L.DomUtil.create("div",e.className,t),n=this._input=L.DomUtil.create("input",e.className+"-input",o),s=this._down=L.DomUtil.create("div",e.className+"-down",o),l=this._up=L.DomUtil.create("div",e.className+"-up",o);return n.type="number",n.step=.1,L.DomEvent.disableClickPropagation(o).disableScrollPropagation(o),n.disabled===!0&&(e.disabled=!0),void 0===e.dmin&&(e.dmin=-Number.MAX_VALUE),void 0===e.dmax&&(e.dmax=Number.MAX_VALUE),void 0===e.step&&(e.step=1),void 0===e.initValue&&(e.initValue=(e.dmin+e.dmax)/2),this.value(e.initValue),n.title=e.title,s.title="Decrease number by "+e.step,l.title="Increase number by "+e.step,L.DomEvent.on(this._input,"change",function(){this.fire("change")},this),e.repButton===!1?(L.DomEvent.on(s,e.clickEvent,function(t){t.preventDefault(),this._offset(t.currentTarget,-1)},this),L.DomEvent.on(l,e.clickEvent,function(t){t.preventDefault(),this._offset(t.currentTarget,1)},this)):(L.DomEvent.on(s,a.startEvent,function(t){n.blur(),a.move=!0,a.cnt=0,a.step=e.step,a.prec=this._prec(a.step),a.delta=-1,this._offset(t.currentTarget,-1),this.runButton||(a.target=t.currentTarget,this.runButton=setTimeout(function(){i._sboxRun()},500))},this),L.DomEvent.on(l,a.startEvent,function(t){n.blur(),a.move=!0,a.cnt=0,a.step=e.step,a.prec=this._prec(a.step),a.delta=1,this._offset(t.currentTarget,1),this.runButton||(a.target=t.currentTarget,this.runButton=setTimeout(function(){i._sboxRun()},500))},this),L.DomEvent.on(s,a.stopEvent,function(t){a.move&&(t.preventDefault(),clearTimeout(this.runButton),this.runButton=!1,a.move=!1,e.instantUpdate===!1&&this.fire("change"))},this),L.DomEvent.on(l,a.stopEvent,function(t){a.move&&(t.preventDefault(),clearTimeout(this.runButton),this.runButton=!1,a.move=!1,e.instantUpdate===!1&&this.fire("change"))},this)),e.disabled&&this.disable(),o},value:function(t){return void 0===t?parseFloat(this._input.value):(this._input.value=t,this)},step:function(t){return void 0===t?this.options.step:(this.options.step=t,this)},disable:function(){var t="disabled";this._input.disabled=!0,this._input.blur(),L.DomUtil.addClass(this._wrap,t),L.DomUtil.addClass(this._down,t),L.DomUtil.addClass(this._up,t),this.options.disabled=!0},enable:function(){var t="disabled";this._input.disabled=!1,L.DomUtil.removeClass(this._wrap,t),L.DomUtil.removeClass(this._down,t),L.DomUtil.removeClass(this._up,t),this.options.disabled=!1},_sboxRun:function(){var t=this,e=150,i=this.options,a=this._drag;20===a.cnt?(e=50,a.step=10*i.step,a.prec=this._prec(a.step)):40===a.cnt?(e=10,a.step=100*i.step,a.prec=this._prec(a.step)):60===a.cnt?(a.step=1e3*i.step,a.prec=this._prec(a.step)):80===a.cnt&&(a.step=1e4*i.step,a.prec=this._prec(a.step)),a.didRun=!0,this._offset(this,a.delta),a.cnt++,this.runButton=setTimeout(function(){t._sboxRun()},e)},_prec:function(t){var e=-.4342944*Math.log(t);return e>0?Math.ceil(e):0},_offset:function(t,e){var i,a=this.options,o=this._input,n=this._drag;this.disabled||(1>e?(i=(parseFloat(o.value)-n.step).toFixed(n.prec),i>=a.dmin&&(o.value=i,a.instantUpdate===!0&&this.fire("change"))):(i=(parseFloat(o.value)+n.step).toFixed(n.prec),i<=a.dmax&&(o.value=i,a.instantUpdate===!0&&this.fire("change"))))}}),L.spinbox=function(t,e){return new L.SpinBox(t,e)},"undefined"!=typeof require)var $=require("jquery-browser");if($.extend($.fn,{fileTree:function(t,e){void 0===t.root&&(t.root="/"),void 0===t.script&&(t.script="dist/filetree.php"),void 0===t.folderEvent&&(t.folderEvent="click"),void 0===t.expandSpeed&&(t.expandSpeed=500),void 0===t.collapseSpeed&&(t.collapseSpeed=500),void 0===t.expandEasing&&(t.expandEasing=null),void 0===t.collapseEasing&&(t.collapseEasing=null),void 0===t.multiFolder&&(t.multiFolder=!0),void 0===t.loadMessage&&(t.loadMessage="Loading..."),$(this).each(function(){function i(e,i){$(e).addClass("wait"),$(".filetree.start").remove(),$.post(t.script,{dir:i},function(o){$(e).find(".start").html(""),$(e).removeClass("wait").append(o),t.root===i?$(e).find("UL:hidden").show():$(e).find("UL:hidden").slideDown({duration:t.expandSpeed,easing:t.expandEasing}),a(e)})}function a(a){$(a).find("LI A").on(t.folderEvent,function(){return $(this).parent().hasClass("directory")?$(this).parent().hasClass("collapsed")?(t.multiFolder||($(this).parent().parent().find("UL").slideUp({duration:t.collapseSpeed,easing:t.collapseEasing}),$(this).parent().parent().find("LI.directory").removeClass("expanded").addClass("collapsed")),$(this).parent().find("UL").remove(),i($(this).parent(),encodeURI($(this).attr("rel").match(/.*\//))),$(this).parent().removeClass("collapsed").addClass("expanded")):($(this).parent().find("UL").slideUp({duration:t.collapseSpeed,easing:t.collapseEasing}),$(this).parent().removeClass("expanded").addClass("collapsed")):e($(this).attr("rel")),!1}),"click"!==t.folderEvent.toLowerCase&&$(a).find("LI A").on("click",function(){return!1})}$(this).html('<ul class="filetree start"><li class="wait">'+t.loadMessage+"<li></ul>"),i($(this),encodeURI(t.root))})}}),L.Control.Attribution.include({_update:function(){if(this._map){var t=[];for(var e in this._attributions)this._attributions[e]&&t.push(e);var i=[];this.options.prefix&&i.push(this.options.prefix),t.length&&i.push(t.join(", ")),this._container.innerHTML=i.join(" &#169; ")}}}),L.Map.addInitHook(function(){this.options.visiomaticLogo!==!1&&this.options.attributionControl&&this.attributionControl.setPrefix('<a id="logo-visiomatic" class="leaflet-control-attribution-logo"href="http://visiomatic.org">&nbsp;</a><a id="logo-iipimage" class="leaflet-control-attribution-logo"href="http://iipimage.sourceforge.net">&nbsp;</a><a id="logo-leaflet" class="leaflet-control-attribution-logo"href="http://leafletjs.com">&nbsp;</a>')}),L.Control.ExtraMap=L.Control.extend({options:{position:"bottomright",title:"Navigation mini-map. Grab to navigate",toggleDisplay:!0,zoomLevelFixed:!1,zoomLevelOffset:-5,zoomAnimation:!1,autoToggleDisplay:!1,width:150,height:150,collapsedWidth:24,collapsedHeight:24,aimingRectOptions:{color:"#FFFFFF",weight:1,clickable:!1},shadowRectOptions:{color:"#FDC82F",weight:1,clickable:!1,opacity:0,fillOpacity:0},strings:{hideText:"Hide map",showText:"Show map"}},initialize:function(t,e){L.Util.setOptions(this,e),this.options.aimingRectOptions.clickable=!1,this.options.shadowRectOptions.clickable=!1,this._layer=t},onAdd:function(t){return this._mainMap=t,this._container=L.DomUtil.create("div","leaflet-control-extramap"),this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",this._container.title=this.options.title,L.DomEvent.disableClickPropagation(this._container),L.DomEvent.on(this._container,"mousewheel",L.DomEvent.stopPropagation),this._extraMap=new L.Map(this._container,{attributionControl:!1,zoomControl:!1,zoomAnimation:this.options.zoomAnimation,autoToggleDisplay:this.options.autoToggleDisplay,touchZoom:!this._isZoomLevelFixed(),scrollWheelZoom:!this._isZoomLevelFixed(),doubleClickZoom:!this._isZoomLevelFixed(),boxZoom:!this._isZoomLevelFixed()}),this._layer.addTo(this._extraMap),this._userToggledDisplay=!1,this._minimized=!1,this.options.toggleDisplay&&this._addToggleButton(),this._layer.once("metaload",function(){this._mainMap.whenReady(L.Util.bind(function(){this._extraMap.whenReady(L.Util.bind(function(){this._aimingRect=L.rectangle(this._mainMap.getBounds(),this.options.aimingRectOptions).addTo(this._extraMap),this._shadowRect=L.rectangle(this._mainMap.getBounds(),this.options.shadowRectOptions).addTo(this._extraMap),this._mainMap.on("moveend",this._onMainMapMoved,this),this._mainMap.on("move",this._onMainMapMoving,this),this._extraMap.on("movestart",this._onExtraMapMoveStarted,this),this._extraMap.on("move",this._onExtraMapMoving,this),this._extraMap.on("moveend",this._onExtraMapMoved,this),this._extraMap.setView(this._mainMap.getCenter(),this._decideZoom(!0)),this._setDisplay(this._decideMinimized())},this))},this))},this),this._container},addTo:function(t){return L.Control.prototype.addTo.call(this,t),this},onRemove:function(){this._mainMap.off("moveend",this._onMainMapMoved,this),this._mainMap.off("move",this._onMainMapMoving,this),this._extraMap.off("moveend",this._onExtraMapMoved,this),this._extraMap.removeLayer(this._layer)},changeLayer:function(t){this._extraMap.removeLayer(this._layer),this._layer=t,this._extraMap.addLayer(this._layer)},_addToggleButton:function(){this._toggleDisplayButton=this.options.toggleDisplay?this._createButton("",this.options.strings.hideText,"leaflet-control-extramap-toggle-display leaflet-control-extramap-toggle-display-"+this.options.position,this._container,this._toggleDisplayButtonClicked,this):void 0,this._toggleDisplayButton.style.width=this.options.collapsedWidth+"px",this._toggleDisplayButton.style.height=this.options.collapsedHeight+"px"},_createButton:function(t,e,i,a,o,n){var s=L.DomUtil.create("a",i,a);s.innerHTML=t,s.href="#",s.title=e;var l=L.DomEvent.stopPropagation;return L.DomEvent.on(s,"click",l).on(s,"mousedown",l).on(s,"dblclick",l).on(s,"click",L.DomEvent.preventDefault).on(s,"click",o,n),s},_toggleDisplayButtonClicked:function(){this._userToggledDisplay=!0,this._minimized?(this._restore(),this._toggleDisplayButton.title=this.options.strings.hideText):(this._minimize(),this._toggleDisplayButton.title=this.options.strings.showText)},_setDisplay:function(t){t!==this._minimized&&(this._minimized?this._restore():this._minimize())},_minimize:function(){this.options.toggleDisplay?(this._container.style.width=this.options.collapsedWidth+"px",this._container.style.height=this.options.collapsedHeight+"px",this._toggleDisplayButton.className+=" minimized-"+this.options.position):this._container.style.display="none",this._minimized=!0},_restore:function(){this.options.toggleDisplay?(this._container.style.width=this.options.width+"px",this._container.style.height=this.options.height+"px",this._toggleDisplayButton.className=this._toggleDisplayButton.className.replace("minimized-"+this.options.position,"")):this._container.style.display="block",this._minimized=!1},_onMainMapMoved:function(){this._extraMapMoving?this._extraMapMoving=!1:(this._mainMapMoving=!0,this._extraMap.setView(this._mainMap.getCenter(),this._decideZoom(!0)),this._setDisplay(this._decideMinimized())),this._aimingRect.setBounds(this._mainMap.getBounds())},_onMainMapMoving:function(){this._aimingRect.setBounds(this._mainMap.getBounds())},_onExtraMapMoveStarted:function(){var t=this._aimingRect.getBounds(),e=this._extraMap.latLngToContainerPoint(t.getSouthWest()),i=this._extraMap.latLngToContainerPoint(t.getNorthEast());this._lastAimingRectPosition={sw:e,ne:i}},_onExtraMapMoving:function(){!this._mainMapMoving&&this._lastAimingRectPosition&&(this._shadowRect.setBounds(new L.LatLngBounds(this._extraMap.containerPointToLatLng(this._lastAimingRectPosition.sw),this._extraMap.containerPointToLatLng(this._lastAimingRectPosition.ne))),this._shadowRect.setStyle({opacity:1,fillOpacity:.3}))},_onExtraMapMoved:function(){this._mainMapMoving?this._mainMapMoving=!1:(this._extraMapMoving=!0,this._mainMap.setView(this._extraMap.getCenter(),this._decideZoom(!1)),this._shadowRect.setStyle({opacity:0,fillOpacity:0}))},_isZoomLevelFixed:function(){var t=this.options.zoomLevelFixed;return this._isDefined(t)&&this._isInteger(t)},_decideZoom:function(t){if(this._isZoomLevelFixed())return t?this.options.zoomLevelFixed:this._mainMap.getZoom();if(t)return this._mainMap.getZoom()+this.options.zoomLevelOffset;var e,i=this._extraMap.getZoom()-this._mainMap.getZoom(),a=this._extraMap.getZoom()-this.options.zoomLevelOffset;return i>this.options.zoomLevelOffset&&this._mainMap.getZoom()<this._extraMap.getMinZoom()-this.options.zoomLevelOffset?this._extraMap.getZoom()>this._lastExtraMapZoom?(e=this._mainMap.getZoom()+1,this._extraMap.setZoom(this._extraMap.getZoom()-1)):e=this._mainMap.getZoom():e=a,this._lastExtraMapZoom=this._extraMap.getZoom(),e},_decideMinimized:function(){return this._userToggledDisplay?this._minimized:this.options.autoToggleDisplay?this._mainMap.getBounds().contains(this._extraMap.getBounds())?!0:!1:this._minimized},_isInteger:function(t){return"number"==typeof t},_isDefined:function(t){return"undefined"!=typeof t}}),L.Map.mergeOptions({extraMapControl:!1}),L.Map.addInitHook(function(){this.options.extraMapControl&&(this.extraMapControl=(new L.Control.ExtraMap).addTo(this))}),L.control.extraMap=function(t,e){return new L.Control.ExtraMap(t,e)},"undefined"!=typeof require)var jQuery=require("jquery-browser");if(function(){L.Control.FullScreen=L.Control.extend({options:{position:"topleft",title:"Toggle full screen mode",forceSeparateButton:!1},onAdd:function(t){var e,i="leaflet-control-zoom-fullscreen";return e=t.zoomControl&&!this.options.forceSeparateButton?t.zoomControl._container:L.DomUtil.create("div","leaflet-bar"),this._createButton(this.options.title,i,e,this.toogleFullScreen,t),e},_createButton:function(e,i,a,o,n){var s=L.DomUtil.create("a",i,a);return s.href="#",s.title=e,L.DomEvent.addListener(s,"click",L.DomEvent.stopPropagation).addListener(s,"click",L.DomEvent.preventDefault).addListener(s,"click",o,n),L.DomEvent.addListener(a,t.fullScreenEventName,L.DomEvent.stopPropagation).addListener(a,t.fullScreenEventName,L.DomEvent.preventDefault).addListener(a,t.fullScreenEventName,this._handleEscKey,n),L.DomEvent.addListener(document,t.fullScreenEventName,L.DomEvent.stopPropagation).addListener(document,t.fullScreenEventName,L.DomEvent.preventDefault).addListener(document,t.fullScreenEventName,this._handleEscKey,n),s},toogleFullScreen:function(){this._exitFired=!1;var e=this._container;this._isFullscreen?(t.supportsFullScreen?t.cancelFullScreen(e):L.DomUtil.removeClass(e,"leaflet-pseudo-fullscreen"),this.invalidateSize(),this.fire("exitFullscreen"),this._exitFired=!0,this._isFullscreen=!1):(t.supportsFullScreen?t.requestFullScreen(e):L.DomUtil.addClass(e,"leaflet-pseudo-fullscreen"),this.invalidateSize(),this.fire("enterFullscreen"),this._isFullscreen=!0)},_handleEscKey:function(){t.isFullScreen(this)||this._exitFired||(this.fire("exitFullscreen"),this._exitFired=!0,this._isFullscreen=!1)}}),L.Map.addInitHook(function(){this.options.fullscreenControl&&(this.fullscreenControl=L.control.fullscreen(this.options.fullscreenControlOptions),this.addControl(this.fullscreenControl))}),L.control.fullscreen=function(t){return new L.Control.FullScreen(t)};var t={supportsFullScreen:!1,isFullScreen:function(){return!1},requestFullScreen:function(){},cancelFullScreen:function(){},fullScreenEventName:"",prefix:""},e="webkit moz o ms khtml".split(" ");if("undefined"!=typeof document.exitFullscreen)t.supportsFullScreen=!0;else for(var i=0,a=e.length;a>i;i++)if(t.prefix=e[i],"undefined"!=typeof document[t.prefix+"CancelFullScreen"]){t.supportsFullScreen=!0;break}t.supportsFullScreen&&(t.fullScreenEventName=t.prefix+"fullscreenchange",t.isFullScreen=function(){switch(this.prefix){case"":return document.fullScreen;case"webkit":return document.webkitIsFullScreen;default:return document[this.prefix+"FullScreen"]}},t.requestFullScreen=function(t){return""===this.prefix?t.requestFullscreen():t[this.prefix+"RequestFullScreen"]()},t.cancelFullScreen=function(){return""===this.prefix?document.exitFullscreen():document[this.prefix+"CancelFullScreen"]()}),"undefined"!=typeof jQuery&&(jQuery.fn.requestFullScreen=function(){return this.each(function(){var e=jQuery(this);t.supportsFullScreen&&t.requestFullScreen(e)})}),window.fullScreenApi=t}(),"undefined"!=typeof require)var $=require("jquery");if(L.Control.IIP=L.Control.extend({options:{title:"a control related to IIPImage",collapsed:!0,position:"topleft"},initialize:function(t,e){L.setOptions(this,e),this._className="leaflet-control-iip",this._id="leaflet-iipimage",this._layers=t},addTo:function(t){return t._sidebar?(this._sidebar=t,this._map=t._map,this._dialog=L.DomUtil.create("div",this._className+"-dialog"),t.addTab(this._id,this._className,this.options.title,this._dialog,this._sideClass),this._map.on("layeradd",this._checkIIP,this),t):L.Control.prototype.addTo.call(this,t)},onAdd:function(){var t=this._className,e=this._id,i=this._container=L.DomUtil.create("div",t+" leaflet-bar");if(i.setAttribute("aria-haspopup",!0),L.DomEvent.disableClickPropagation(i).disableScrollPropagation(i),this._dialog=L.DomUtil.create("div",t+"-dialog",i),this.options.collapsed){L.Browser.android||L.DomEvent.on(i,"mouseover",this._expand,this).on(i,"mouseout",this._collapse,this);var a=this._toggle=L.DomUtil.create("a",t+"-toggle leaflet-bar",i);a.href="#",a.id=e+"-toggle",a.title=this.options.title,L.Browser.touch?L.DomEvent.on(a,"click",L.DomEvent.stop).on(a,"click",this._expand,this):L.DomEvent.on(a,"focus",this._expand,this),this._map.on("click",this._collapse,this)}else this._expand();return this._map.on("layeradd",this._checkIIP,this),this._container},_checkIIP:function(t){var e=t.layer;e&&e.iipdefault&&(this._layer=e,this._reloadFlag?e.once("load",this._resetDialog,this):(this._initDialog(),this._reloadFlag=!0))},_initDialog:function(){},_resetDialog:function(){this._dialog.innerHTML="",this._initDialog()},_addDialogBox:function(t){var e=L.DomUtil.create("div",this._className+"-box",this._dialog);return t&&(e.id=t),e},_addDialogLine:function(t,e){var i=L.DomUtil.create("div",this._className+"-line",e),a=L.DomUtil.create("div",this._className+"-label",i);return a.innerHTML=t,i},_addDialogElement:function(t){return L.DomUtil.create("div",this._className+"-element",t)},_expand:function(){L.DomUtil.addClass(this._container,this._className+"-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" "+this._className+"-expanded","")},getActiveBaseLayer:function(){return this._activeBaseLayer},_findActiveBaseLayer:function(){var t=this._layers;this._prelayer=void 0;for(var e in t){var i=t[e];if(!i.overlay)if(i._map){if(this._map.hasLayer(i)&&i.iipdefault)return i}else this._prelayer=i}return void 0},_createButton:function(t,e,i,a,o){var n=L.DomUtil.create("a",t,e);return n.target="_blank",i&&(n.id=t+"-"+i),a&&L.DomEvent.on(n,"click touch",a,this),o&&(n.title=o),n},_createRadioButton:function(t,e,i,a,o,n){var s=L.DomUtil.create("input",t,e);s.type="radio",s.name=t,s.value=i,s.checked=a,o&&L.DomEvent.on(s,"click touch",o,i);var l=L.DomUtil.create("label",t,e);return l.htmlFor=s.id=t+"-"+i,n&&(l.title=n),s},_createSelectMenu:function(t,e,i,a,o,n,s){var l,r=L.DomUtil.create("div",t,e),c=L.DomUtil.create("select",t,r),h=document.createElement("option"),p=c.opt=[];h.text="choose",h.disabled=!0,(!o||0>o)&&(h.selected=!0),c.add(h,null);for(var d in i)l=parseInt(d,10),p[l]=document.createElement("option"),p[l].text=i[l],p[l].value=l,a&&a[l]?p[l].disabled=!0:l===o&&(p[l].selected=!0),c.add(p[l],null);return this._container&&!L.Browser.android&&this.options.collapsed&&(L.DomEvent.on(c,"mousedown",function(){L.DomEvent.off(this._container,"mouseout",this._collapse,this),this.collapsedOff=!0},this),L.DomEvent.on(this._container,"mouseover",function(){this.collapsedOff&&(L.DomEvent.on(this._container,"mouseout",this._collapse,this),this.collapsedOff=!1)},this)),n&&L.DomEvent.on(c,"change keyup",n,this),s&&(r.title=s),c},_createColorPicker:function(t,e,i,a,o,n,s){var l=this,r=L.DomUtil.create("input",t,e);return r.type="color",r.value=a,r.id=t+"-"+i,$(document).ready(function(){$(r).spectrum({showInput:!0,appendTo:"#"+l._id,showPaletteOnly:!0,togglePaletteOnly:!0,localStorageKey:n,change:function(t){r.value=t.toHexString()}}).on("show.spectrum",function(){l._container&&L.DomEvent.off(l._container,"mouseout",l._collapse)}),o&&$(r).on("change",o),s&&$("#"+r.id+"+.sp-replacer").prop("title",s)}),r},_addSwitchInput:function(t,e,i,a,o,n,s){var l=this._addDialogLine(i,e),r=this._addDialogElement(l),c=L.flipswitch(r,{checked:s,id:n,title:o});return c.on("change",function(){this._onInputChange(t,a,c.value())},this),r},_addNumericalInput:function(t,e,i,a,o,n,s,l,r,c,h){var p=this._addDialogLine(i,e),d=this._addDialogElement(p),u=d.spinbox=L.spinbox(d,{step:l,dmin:r,dmax:c,initValue:s,title:o});return u.on("change",function(){L.IIPUtils.flashElement(u._input),this._onInputChange(t,a,u.value(),h)},this),d},_spinboxStep:function(t,e){var i=parseFloat((.01*Math.abs(e===t?e:e-t)).toPrecision(1));return 0===i?1:i},_onInputChange:function(t,e,i,a){var o=e.split(/\[|\]/);o[1]?t[o[0]][parseInt(o[1],10)]=i:t[o[0]]=i,a&&a(t),t.redraw()},_updateLayerList:function(){if(!this._dialog)return this;this._layerList?L.DomUtil.empty(this._layerList):this._layerList=L.DomUtil.create("div","leaflet-control-iip-layerlist",this._dialog);for(var t in this._layers)this._addLayerItem(this._layers[t]);return this},_addLayerItem:function(t){var e=this,i=L.DomUtil.create("div","leaflet-control-iip-layer"),a=L.DomUtil.create("div","leaflet-control-iip-layerswitch",i);if(t.layer.notReady)L.DomUtil.create("div","leaflet-control-iip-activity",a);else{var o,n=this._map.hasLayer(t.layer);o=document.createElement("input"),o.type="checkbox",o.className="leaflet-control-iip-selector",o.defaultChecked=n,o.layerId=L.stamp(t.layer),L.DomEvent.on(o,"click",function(){var t,e,i,a=this._layerList.getElementsByTagName("input"),o=a.length;for(this._handlingClick=!0,t=0;o>t;t++)e=a[t],"layerId"in e&&(i=this._layers[e.layerId],e.checked&&!this._map.hasLayer(i.layer)?i.layer.addTo(this._map):!e.checked&&this._map.hasLayer(i.layer)&&this._map.removeLayer(i.layer));this._handlingClick=!1},this),a.appendChild(o)}var s=L.DomUtil.create("div","leaflet-control-iip-layername",i);return s.innerHTML=" "+t.name,s.style.textShadow="0px 0px 5px "+t.layer.nameColor,this._createButton("leaflet-control-iip-trash",i,void 0,function(){e.removeLayer(t.layer),t.notReady||e._map.removeLayer(t.layer)},"Delete layer"),this._layerList.appendChild(i),i},addLayer:function(t,e,i){t.on("add remove",this._onLayerChange,this);var a=L.stamp(t);return this._layers[a]={layer:t,name:e,index:i},this._updateLayerList()},removeLayer:function(t){return t.off("add remove",this._onLayerChange,this),t.fire("trash",{index:this._layers[L.stamp(t)].index}),t.off("trash"),delete this._layers[L.stamp(t)],this._updateLayerList()},_onLayerChange:function(t){this._handlingClick||this._updateLayerList();var e=this._layers[L.stamp(t.target)],i="add"===t.type?"overlayadd":"overlayremove";this._map.fire(i,e)}}),L.control.iip=function(t,e){return new L.Control.IIP(t,e)},"undefined"!=typeof require)var $=require("jquery");if(L.Control.IIP.Catalog=L.Control.IIP.extend({defaultCatalogs:[L.Catalog.GAIA_DR1,L.Catalog["2MASS"],L.Catalog.SDSS,L.Catalog.PPMXL,L.Catalog.Abell],options:{title:"Catalog overlays",collapsed:!0,position:"topleft",nativeCelsys:!0,color:"#FFFF00",timeOut:30,authenticate:!1},initialize:function(t,e){L.setOptions(this,e),this._className="leaflet-control-iip",this._id="leaflet-iipcatalog",this._layers={},this._handlingClick=!1,this._sideClass="catalog",this._catalogs=t?t:this.defaultCatalogs},_initDialog:function(){var t=this._className,e=this._catalogs,i=this._addDialogBox(),a=this._addDialogLine('<a id="logo-cds" href="http://cds.u-strasbg.fr">&nbsp;</a>',i),o=this._addDialogElement(a),n=this._createColorPicker(t+"-color",o,"catalog",this.options.color,!1,"iipCatalog","Click to set catalog color"),s=this._createSelectMenu(this._className+"-select",o,e.map(function(t){return t.name}),void 0,-1,void 0,"Select Catalog");L.DomEvent.on(s,"change keyup",function(){s.title=e[s.selectedIndex-1].attribution},this),o=this._addDialogElement(a),this._createButton(t+"-button",o,"catalog",function(){var t=s.selectedIndex-1;if(t>=0){var i=e[t];i.color=n.value,s.selectedIndex=0,s.title="Select Catalog",this._getCatalog(i,this.options.timeOut)}},"Query catalog")},_resetDialog:function(){},_getCatalog:function(t,e){var i=this,a=this._map,o=a.options.crs,n=o.forceNativeCelsys&&!this.options.nativeCelsys,s=n?o.celsysToEq(a.getCenter()):a.getCenter(),l=a.getPixelBounds(),r=a.getZoom(),c=new L.LayerGroup(null);c.notReady=!0,this.addLayer(c,t.name),this.options.authenticate=t.authenticate?t.authenticate:!1;var h,p=Math.abs(Math.cos(s.lat*Math.PI/180)),d=n?[o.celsysToEq(a.unproject(l.min,r)),o.celsysToEq(a.unproject(L.point(l.min.x,l.max.y),r)),o.celsysToEq(a.unproject(l.max,r)),o.celsysToEq(a.unproject(L.point(l.max.x,l.min.y),r))]:[a.unproject(l.min,r),a.unproject(L.point(l.min.x,l.max.y),r),a.unproject(l.max,r),a.unproject(L.point(l.max.x,l.min.y),r)];if(o.forceNativeCelsys&&this.options.nativeCelsys)switch(o.celsyscode){case"ecliptic":h="E2000.0";break;case"galactic":h="G";break;case"supergalactic":h="S";break;default:h="J2000.0"}else h="J2000.0";if("box"===t.regionType){var u=(Math.max(o._deltaLng(d[0],s),o._deltaLng(d[1],s),o._deltaLng(d[2],s),o._deltaLng(d[3],s))-Math.min(o._deltaLng(d[0],s),o._deltaLng(d[1],s),o._deltaLng(d[2],s),o._deltaLng(d[3],s)))*p,m=Math.max(d[0].lat,d[1].lat,d[2].lat,d[3].lat)-Math.min(d[0].lat,d[1].lat,d[2].lat,d[3].lat);1e-4>m&&(m=1e-4),1e-4>u&&(u=1e-4),L.IIPUtils.requestURL(L.Util.template(t.url,L.extend({sys:h,lng:s.lng.toFixed(6),lat:s.lat.toFixed(6),dlng:u.toFixed(4),dlat:m.toFixed(4),nmax:t.nmax+1,maglim:t.maglim})),"getting "+t.service+" data",function(e,a){i._loadCatalog(t,c,e,a)},this,e)}else{var _=Math.max(o.distance(d[0],s),o.distance(d[0],s),o.distance(d[0],s),o.distance(d[0],s));L.IIPUtils.requestURL(L.Util.template(t.url,L.extend({sys:h,lng:s.lng.toFixed(6),lat:s.lat.toFixed(6),dr:_.toFixed(4),nmax:t.nmax+1})),"querying "+t.service+" data",function(e,a){i._loadCatalog(t,c,e,a)},this,this.options.timeOut)}},_loadCatalog:function(t,e,i,a){if(4===a.readyState)if(200===a.status){var o,n=i._map.options.crs,s=a.responseText,l=t.toGeoJSON(s),r=L.geoJson(l,{onEachFeature:function(e,i){e.properties&&e.properties.items&&i.bindPopup(t.popup(e))},coordsToLatLng:function(t){if(n.forceNativeCelsys){var e=n.eqToCelsys(L.latLng(t[1],t[0]));return new L.LatLng(e.lat,e.lng,t[2])}return new L.LatLng(t[1],t[0],t[2])},pointToLayer:function(e,i){return t.draw(e,i)},style:function(){return{color:t.color,weight:2}}});r.nameColor=t.color,r.addTo(i._map),this.removeLayer(e),l.features.length>t.nmax&&(l.features.pop(),o=!0),this.addLayer(r,t.name+" ("+l.features.length.toString()+(o?"+ entries)":" entries)")),o&&alert("Selected area is too large: "+t.name+" sample has been truncated to the first "+t.nmax+" sources.")}else 0!==a.status&&alert("Error "+a.status+" while querying "+t.service+"."),this.removeLayer(e)}}),L.control.iip.catalog=function(t,e){return new L.Control.IIP.Catalog(t,e)},"undefined"!=typeof require)var $=require("jquery");if(L.Control.IIP.Channel=L.Control.IIP.extend({options:{title:"Channel mixing",collapsed:!0,cMap:"grey",mixingMode:null,position:"topleft"},initialize:function(t,e){L.setOptions(this,e),this._className="leaflet-control-iip",this._id="leaflet-iipchannel",this._sideClass="channel",this._settings=[],this._initsettings=[]},saveSettings:function(t,e,i){e[i]||(e[i]={});var a=e[i],o=t.iipNChannel;a.channel=t.iipChannel,a.cMap=t.iipCMap,a.rgb=[];for(var n=0;o>n;n++)a.rgb[n]=t.iipRGB[n].clone()},loadSettings:function(t,e,i,a){var o=e[i],n=t.iipNChannel;if(o){a||(t.iipChannel=o.channel),t.iipCMap=o.cMap;for(var s=0;n>s;s++)t.iipRGB[s]=o.rgb[s].clone()}},_initDialog:function(){var t=this,e=this._layer,i=this._className,a=this._dialog;this.saveSettings(e,this._initsettings,"mono"),this.saveSettings(e,this._initsettings,"color"),this.saveSettings(e,this._settings,"mono"),this.saveSettings(e,this._settings,"color"),this._mode=this.options.mixingMode?this.options.mixingMode:e.iipMode;var o,n,s=this._addDialogBox(),l=this._addDialogLine("Mode:",s),r=this._addDialogElement(l),c=L.DomUtil.create("div",i+"-radios",r);n=this._createRadioButton(i+"-radio",c,"mono","mono"===this._mode,function(){for(t.saveSettings(e,t._settings,t._mode),o=s.lastChild;o!==l;o=s.lastChild)s.removeChild(o);for(o=a.lastChild;o!==s;o=a.lastChild)a.removeChild(o);t._channelList=void 0,t.loadSettings(e,t._settings,"mono"),t._initMonoDialog(e,s),t._mode="mono"},"Select mono-channel palettized mode"),n=this._createRadioButton(i+"-radio",c,"color","mono"!==this._mode,function(){for(t.saveSettings(e,t._settings,t._mode),o=s.lastChild;o!==l;o=s.lastChild)s.removeChild(o);for(o=a.lastChild;o!==s;o=a.lastChild)a.removeChild(o);t.loadSettings(e,t._settings,"color"),t._channelList=void 0,t._initColorDialog(e,s),t._mode="color"
},"Select color mixing mode"),"mono"===t._mode?t._initMonoDialog(e,s):t._initColorDialog(e,s)},_initMonoDialog:function(t,e){var i=this,a=(t.iipChannelLabels,this._className),o=this._addDialogLine("Channel:",e),n=this._addDialogElement(o);t.updateMono(),this._chanSelect=this._createSelectMenu(this._className+"-select",n,t.iipChannelLabels,void 0,t.iipChannel,function(){t.iipChannel=parseInt(this._chanSelect.selectedIndex-1,10),this._updateChannel(t,t.iipChannel),t.redraw()},"Select image channel"),o=this._addDialogLine("LUT:",e),n=this._addDialogElement(o);var s,l=L.DomUtil.create("div",a+"-cmaps",n),r=[],c=["grey","jet","cold","hot"],h=function(){i._onInputChange(t,"iipCMap",this)};for(s in c)r[s]=this._createRadioButton("leaflet-cmap",l,c[s],c[s]===this.options.cMap,h,'"'+c[s].charAt(0).toUpperCase()+c[s].substr(1)+'" color-map');this._addMinMax(t,t.iipChannel,e),t.redraw()},_initColorDialog:function(t,e){var i=this,a=this._className,o=this._addDialogLine("Channel:",e),n=this._addDialogElement(o),s=this._chanColPick=this._createColorPicker(a+"-color",n,"channel",t.iipRGB[t.iipChannel].toStr(),function(){var e=t.iipChannel,a=$(s).val();i._updateMix(t,e,L.rgb(a)),i.collapsedOff=!0},"iipChannel","Click to set channel color");this._onInputChange(t,"iipCMap","grey"),t.updateMix(),this._chanSelect=this._createSelectMenu(this._className+"-select",n,t.iipChannelLabels,void 0,t.iipChannel,function(){t.iipChannel=this._chanSelect.selectedIndex-1,this._updateChannel(t,t.iipChannel,s)},"Select image channel"),this._addMinMax(t,t.iipChannel,e),o=this._addDialogLine("Colors:",e),n=this._addDialogElement(o),this._createButton(a+"-button",n,"colormix-reset",function(){i.loadSettings(t,i._initsettings,"color",!0),t.updateMix(),this._updateColPick(t),this._updateChannelList(t),t.redraw()},"Reset color mix"),this._createButton(a+"-button",n,"colormix-auto",function(){for(var e=t.iipNChannel,i=0,a=0,o=t.iipRGB,n=t.iipdefault.channelColors,s=0;e>s;s++)o[s].isOn()&&a++;for(a>=n.length&&(a=n.length-1),s=0;e>s;s++)o[s].isOn()&&a>i&&(o[s]=L.rgb(n[a][i++]));t.updateMix(),this._updateColPick(t),this._updateChannelList(t),t.redraw()},"Re-color active channels"),i._updateChannelList(t),t.redraw()},_addMinMax:function(t,e,i){var a=this._spinboxStep(t.iipMinValue[e],t.iipMaxValue[e]);this._minElem=this._addNumericalInput(t,i,"Min:","iipMinValue["+e+"]","Lower clipping limit in "+t.iipChannelUnits[e]+".","leaflet-channel-minvalue",t.iipMinValue[e],a),this._maxElem=this._addNumericalInput(t,i,"Max:","iipMaxValue["+e+"]","Upper clipping limit in "+t.iipChannelUnits[e]+".","leaflet-channel-maxvalue",t.iipMaxValue[e],a)},_updateChannel:function(t,e,i){var a=this,o=this._spinboxStep(t.iipMinValue[e],t.iipMaxValue[e]);a._chanSelect.selectedIndex=e+1,i&&($(i).spectrum("set",t.iipRGB[e].toStr()),$(i).val(t.iipRGB[e].toStr()).off("change").on("change",function(){a._updateMix(t,e,L.rgb($(i).val()))})),this._minElem.spinbox.value(t.iipMinValue[e]).step(o).off("change").on("change",function(){a._onInputChange(t,"iipMinValue["+e+"]",a._minElem.spinbox.value())},this),this._maxElem.spinbox.value(t.iipMaxValue[e]).step(o).off("change").on("change",function(){a._onInputChange(t,"iipMaxValue["+e+"]",a._maxElem.spinbox.value())},this)},_updateMix:function(t,e,i){t.rgbToMix(e,i),this._updateChannelList(t),t.redraw()},_updateChannelList:function(t){var e,i,a,o,n,s,l,r=t.iipChannelLabels,c=this._channelList,h=this._channelElems,p=this._trashElems;c?L.DomUtil.empty(this._channelList):c=this._channelList=L.DomUtil.create("div",this._className+"-chanlist",this._dialog),h=this._channelElems=[],p=this._trashElems=[];for(s in r)l=parseInt(s,10),a=t.iipRGB[l],a.isOn()&&(e=L.DomUtil.create("div",this._className+"-channel",c),o=L.DomUtil.create("div",this._className+"-chancolor",e),o.style.backgroundColor=a.toStr(),this._activateChanElem(o,t,l),n=L.DomUtil.create("div",this._className+"-chanlabel",e),n.innerHTML=r[s],this._activateChanElem(n,t,l),i=this._createButton("leaflet-control-iip-trash",e,void 0,void 0,"Delete channel"),this._activateTrashElem(i,t,l),h.push(e),p.push(i))},_updateColPick:function(t){$(this._chanColPick).spectrum("set",t.iipRGB[t.iipChannel].toStr()),$(this._chanColPick).val(t.iipRGB[t.iipChannel].toStr())},_activateTrashElem:function(t,e,i){L.DomEvent.on(t,"click touch",function(){this._updateMix(e,i,L.rgb(0,0,0)),e===this._layer&&i===e.iipChannel&&this._updateColPick(e)},this)},_activateChanElem:function(t,e,i){L.DomEvent.on(t,"click touch",function(){e.iipChannel=i,this._updateChannel(e,i,this._chanColPick)},this)}}),L.control.iip.channel=function(t){return new L.Control.IIP.Channel(t)},"undefined"!=typeof require)var $=require("jquery");if(L.Control.IIP.Doc=L.Control.IIP.extend({options:{title:"Documentation",collapsed:!0,position:"topleft",pdflink:void 0},initialize:function(t,e){L.setOptions(this,e),this._className="leaflet-control-iip",this._id="leaflet-iipdoc",this._sideClass="doc",this._url=t},_initDialog:function(){var t=this._className,e=(this._layer,L.DomUtil.create("div",this._className+"-framebox",this._dialog)),i=this._iframe=L.DomUtil.create("iframe",this._className+"-doc",e);i.src=this._url,i.frameborder=0,this._navHistory=[],this._navPos=0,this._ignore=!1,L.DomEvent.on(i,"load hashchange",this._onloadNav,this);var a=this._addDialogBox("leaflet-iipdoc-dialog"),o=this._addDialogLine("Navigate:",a),n=this._addDialogElement(o);if(this._homeButton=this._createButton(t+"-button",n,"home",this._homeNav,"Navigate home"),this._backButton=this._createButton(t+"-button",n,"back",this._backNav,"Navigate backward"),this._forwardButton=this._createButton(t+"-button",n,"forward",this._forwardNav,"Navigate forward"),this.options.pdflink){var s=this._createButton(t+"-button",n,"pdf",void 0,"Download PDF version");s.href=this.options.pdflink}},_updateNav:function(t){t!==this._navPos&&(this._navPos=t,this._navIgnore=!0,this._iframe.src=this._navHistory[this._navPos-1],this._disableNav())},_disableNav:function(){this._backButton.disabled=1===this._navPos,this._forwardButton.disabled=this._navPos>=this._navHistory.length},_backNav:function(){this._backButton.disabled||this._updateNav(Math.max(1,this._navPos-1))},_forwardNav:function(){this._forwardButton.disabled||this._updateNav(Math.min(this._navHistory.length,this._navPos+1))},_homeNav:function(){this._backButton.disabled||this._updateNav(1)},_onloadNav:function(){for(var t=this._iframe.contentDocument.getElementsByTagName("a"),e=0;e<t.length;e++)L.IIPUtils.isExternal(t[e].href)&&t[e].setAttribute("target","_blank");if(this._iframeLoad1=!0,this._navIgnore)this._navIgnore=!1;else{var i=this._iframe.contentWindow.location.href;i!==this._navHistory[this._navPos-1]&&(this._navHistory.splice(this._navPos,this._navHistory.length-this._navPos),this._navHistory.push(i),this._navPos=this._navHistory.length,this._disableNav())}}}),L.control.iip.doc=function(t,e){return new L.Control.IIP.Doc(t,e)},"undefined"!=typeof require)var $=require("jquery");if(L.Control.IIP.Image=L.Control.IIP.extend({options:{title:"Image preferences",collapsed:!0,position:"topleft"},initialize:function(t){L.setOptions(this,t),this._className="leaflet-control-iip",this._id="leaflet-iipimage",this._sideClass="image"},_initDialog:function(){var t=(this._className,this._layer);this._map,this._addSwitchInput(t,this._dialog,"Invert:","iipInvertCMap","Invert color map(s)","leaflet-invertCMap",t.iipInvertCMap),this._addNumericalInput(t,this._dialog,"Contrast:","iipContrast","Adjust Contrast. 1.0: normal.","leaflet-contrastValue",t.iipContrast,.05,0,10),this._addNumericalInput(t,this._dialog,"Color Sat.:","iipColorSat","Adjust Color Saturation. 0: B&W, 1.0: normal.","leaflet-colorsatvalue",t.iipColorSat,.05,0,5,this._updateMix),this._addNumericalInput(t,this._dialog,"Gamma:","iipGamma","Adjust Gamma correction. The standard value is 2.2.","leaflet-gammavalue",t.iipGamma,.05,.5,5),this._addNumericalInput(t,this._dialog,"JPEG quality:","iipQuality","Adjust JPEG compression quality. 1: lowest, 100: highest","leaflet-qualvalue",t.iipQuality,1,1,100)},_updateMix:function(t){for(var e=t.iipNChannel,i=0;e>i;i++)t.rgbToMix(i)}}),L.control.iip.image=function(t){return new L.Control.IIP.Image(t)},"undefined"!=typeof require)var $=require("jquery");if(L.Control.IIP.Profile=L.Control.IIP.extend({options:{title:"Profile overlays",collapsed:!0,position:"topleft",profile:!0,profileColor:"#FF00FF",spectrum:!0,spectrumColor:"#A000FF"},initialize:function(t){L.setOptions(this,t),this._className="leaflet-control-iip",this._id="leaflet-iipprofile",this._layers={},this._sideClass="profile",this._handlingClick=!1},_initDialog:function(){var t,e,i=this,a=this.options,o=this._className,n=this._addDialogBox();if(a.profile){t=this._addDialogLine("Profile:",n),e=this._addDialogElement(t);var s=this._createColorPicker(o+"-color",e,"profile",a.profileColor,!1,"iipProfile","Click to set line color");this._createButton(o+"-button",e,"start",function(){if(this._currProfileLine)this._updateLine();else{var t=i._map,e=t.getCenter(),a=this._currProfileLine=L.polyline([e,e],{color:s.value,weight:7,opacity:.5});a.nameColor=s.value,a.addTo(t),t.on("drag",this._updateLine,this)}},"Start drawing a profile line"),this._createButton(o+"-button",e,"end",this._profileEnd,"End line and plot")}if(a.spectrum){t=this._addDialogLine("Spectrum:",n),e=this._addDialogElement(t);var l=this._createColorPicker(o+"-color",e,"spectrum",a.spectrumColor,!1,"iipSpectra","Click to set marker color");this._createButton(o+"-button",e,"spectrum",function(){var t=i._map,e=t.getCenter(),a=t.options.crs.options.nzoom-1,o=t.project(e,a).round(),n=t.unproject(o,a),s=this._spectrumMarker=L.circleMarker(n,{color:l.value,radius:6,title:"Spectrum"}).addTo(t),r=L.DomUtil.create("div",this._className+"-popup");L.DomUtil.create("div",this._className+"-activity",r),r.id="leaflet-spectrum-plot",s.bindPopup(r,{minWidth:16,maxWidth:1024,closeOnClick:!1}).openPopup(),L.IIPUtils.requestURL(this._layer._url.replace(/\&.*$/g,"")+"&PFL="+a.toString()+":"+o.x.toFixed(0)+","+o.y.toFixed(0)+"-"+o.x.toFixed(0)+","+o.y.toFixed(0),"getting IIP layer spectrum",this._plotSpectrum,this)},"Plot a spectrum at the current map position")}},_updateLine:function(){var t=this._map,e=(t.getCenter(),t.options.crs.options.nzoom-1),i=this._currProfileLine.getLatLngs(),a=t.project(i[0],e),o=t.project(t.getCenter(),e);Math.abs(a.x-o.x)>Math.abs(a.y-o.y)?o.y=a.y:o.x=a.x,i[1]=t.unproject(o,e),this._currProfileLine.redraw()},_profileEnd:function(){var t=this._map,e=(t.getCenter(),this._profileLine=this._currProfileLine);t.off("drag",this._updateLine,this),this._currProfileLine=void 0;var i=L.DomUtil.create("div",this._className+"-popup");L.DomUtil.create("div",this._className+"-activity",i),i.id="leaflet-profile-plot",e.bindPopup(i,{minWidth:16,maxWidth:1024,closeOnClick:!1}).openPopup();var a,o,n=t.options.crs.options.nzoom-1,s=e.getLatLngs(),l=t.project(s[0],n),r=t.project(s[1],n);r.x<l.x&&(a=r.x,r.x=l.x,l.x=a),r.y<l.y&&(o=r.y,r.y=l.y,l.y=o),L.IIPUtils.requestURL(this._layer._url.replace(/\&.*$/g,"")+"&PFL="+n.toString()+":"+l.x.toFixed(0)+","+l.y.toFixed(0)+"-"+r.x.toFixed(0)+","+r.y.toFixed(0),"getting IIP layer profile",this._plotProfile,this)},_getMeasurementString:function(){var t,e,i,a=this._currentLatLng,o=this._markers[this._markers.length-1].getLatLng();return t=this._measurementRunningTotal+L.IIPUtils.distance(a,o),t>=1?i="&#176;":(t*=60,t>=1?i="&#39;":(t*=60,i="&#34;")),e=t.toFixed(2)+i},_plotProfile:function(t,e){if(4===e.readyState&&200===e.status){var i,a,o=JSON.parse(e.responseText),n=o.profile,s=t._layer,l=t._profileLine,r=document.getElementById("leaflet-profile-plot"),c=[],h=[];if(t.addLayer(l,"Image profile"),"mono"===s.iipMode)c.push(t._extractProfile(s,n,s.iipChannel)),h.push({color:"black"}),i="Image profile for "+s.iipChannelLabels[s.iipChannel],a="Pixel value in "+s.iipChannelUnits[s.iipChannel];else{for(var p=s.iipRGB,d=0;d<s.iipNChannel;d++)p[d].isOn()&&(c.push(t._extractProfile(s,n,d)),h.push({color:p[d].toStr(),label:s.iipChannelLabels[d]}));i="Image profiles",a="Pixel value"}$(document).ready(function(){$.jqplot.config.enablePlugins=!0,$.jqplot("leaflet-profile-plot",c,{title:i,grid:{backgroundColor:"#ddd",gridLineColor:"#eee"},axes:{xaxis:{label:"position along line",labelRenderer:$.jqplot.CanvasAxisLabelRenderer,pad:1},yaxis:{label:a,labelRenderer:$.jqplot.CanvasAxisLabelRenderer,pad:1}},legend:{show:"mono"!==s.iipMode,location:"ne"},highlighter:{show:!0,sizeAdjust:2,tooltipLocation:"n",tooltipAxes:"y",tooltipFormatString:"%.6g "+s.iipChannelUnits[s.iipChannel],useAxesFormatters:!1,bringSeriesToFront:!0},cursor:{show:!0,zoom:!0},series:h,seriesDefaults:{lineWidth:2,showMarker:!1}})}),r.removeChild(r.childNodes[0]),l._popup.update()}},_extractProfile:function(t,e,i){for(var a=[],o=t.iipNChannel,n=e.length/o,s=0;n>s;s++)a.push(e[s*o+i]);return a},_plotSpectrum:function(t,e){if(4===e.readyState&&200===e.status){var i,a,o=JSON.parse(e.responseText),n=o.profile,s=t._layer,l=t._spectrumMarker,r=document.getElementById("leaflet-spectrum-plot"),c=[];t.addLayer(l,"Image spectrum");for(var h=0;h<s.iipNChannel;h++)c.push([s.iipChannelLabels[h],t._extractAverage(s,n,h)]);i="Image Spectrum",a="Average pixel value",$(document).ready(function(){$.jqplot.config.enablePlugins=!0,$.jqplot("leaflet-spectrum-plot",[c],{title:i,grid:{backgroundColor:"#F0F0F0",gridLineColor:"#F8F8F8"},axes:{xaxis:{renderer:$.jqplot.CategoryAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{angle:-30,fontSize:"6pt"}},yaxis:{label:a,labelRenderer:$.jqplot.CanvasAxisLabelRenderer}},highlighter:{show:!0,sizeAdjust:2,tooltipLocation:"n",tooltipAxes:"y",tooltipFormatString:"%.6g "+s.iipChannelUnits[s.iipChannel],useAxesFormatters:!1},cursor:{show:!0,zoom:!0},seriesDefaults:{lineWidth:2,showMarker:!1}})}),r.removeChild(r.childNodes[0]),l._popup.update()}},_extractAverage:function(t,e,i){var a=t.iipNChannel,o=e.length/a,n=0;if(0===o)return 0;for(var s=0;o>s;s++)n+=e[s*a+i];return n/o}}),L.control.iip.profile=function(t){return new L.Control.IIP.Profile(t)},L.Control.IIP.Region=L.Control.IIP.extend({options:{title:"Region overlays",collapsed:!0,position:"topleft",nativeCelsys:!0,color:"#00FFFF",timeOut:30},initialize:function(t,e){L.setOptions(this,e),this._className="leaflet-control-iip",this._id="leaflet-iipregion",this._layers={},this._handlingClick=!1,this._sideClass="region",this._regions=t&&t[0]?t:[]},_initDialog:function(){var t=this._className,e=this._regions,i=this._addDialogBox(),a=this._addDialogLine("Regions:",i),o=this._addDialogElement(a),n=this._createColorPicker(t+"-color",o,"region",this.options.color,!1,"iipRegion","Click to set region color"),s=this._regionSelect=this._createSelectMenu(this._className+"-select",o,e.map(function(t){return t.name}),e.map(function(t){return t.load?!0:!1}),-1,void 0,"Select region");o=this._addDialogElement(a),this._createButton(t+"-button",o,"region",function(){var t=s.selectedIndex-1;if(t>=0){var e=this._regions[t];e.color=n.value,s.selectedIndex=0,s.opt[t].disabled=!0,this._getRegion(e,this.options.timeOut)}},"Display region");for(var l,r=0;r<e.length;r++)l=e[r],l.index=r,l.load===!0&&(l.color||(l.color=this.options.color),this._getRegion(e[r],this.options.timeOut))},_resetDialog:function(){},_getRegion:function(t){var e=this,i=this._map,a=i.options.crs,o=(a.forceNativeCelsys&&!this.options.nativeCelsys,new L.LayerGroup(null));o.notReady=!0,this.addLayer(o,t.name),L.IIPUtils.requestURL(t.url,"loading "+t.name+" data",function(i,a){e._loadRegion(t,o,i,a)},this,this.options.timeOut)},_loadRegion:function(t,e,i,a){if(4===a.readyState)if(200===a.status){var o=i._map.options.crs,n=a.responseText,s=L.geoJson(JSON.parse(n),{onEachFeature:function(e,i){e.properties&&e.properties.description?i.bindPopup(e.properties.description):t.description&&i.bindPopup(t.description)},coordsToLatLng:function(t){if(o.forceNativeCelsys){var e=o.eqToCelsys(L.latLng(t[1],t[0]));return new L.LatLng(e.lat,e.lng,t[2])}return new L.LatLng(t[1],t[0],t[2])},style:function(){return{color:t.color,weight:2}},pointToLayer:function(e,i){return t.drawPoint?t.drawPoint(e,i):L.marker(i)}});s.nameColor=t.color,s.addTo(i._map),i.removeLayer(e),i.addLayer(s,t.name,t.index),L.DomEvent.on(s,"trash",function(t){(t.index||0===t.index)&&(i._regionSelect.opt[t.index].disabled=!1)},i)}else 0!==a.status&&alert("Error "+a.status+" while downloading "+t.url+"."),i.removeLayer(e),i._regionSelect.opt[t.index].disabled=!1}}),L.control.iip.region=function(t,e){return new L.Control.IIP.Region(t,e)},"undefined"!=typeof require)var $=require("jquery"),html2canvas=require("html2canvas");if(L.Control.IIP.Snapshot=L.Control.IIP.extend({options:{title:"Field snapshot",collapsed:!0,position:"topleft"},initialize:function(t){L.setOptions(this,t),this._className="leaflet-control-iip",this._id="leaflet-iipsnapshot",this._sideClass="snapshot"},_initDialog:function(){var t=this._className,e=this._layer,i=this._map,a=this._addDialogLine("Snap:",this._dialog),o=this._addDialogElement(a),n=["Screen pixels","Native pixels"];this._snapType=0,this._snapSelect=this._createSelectMenu(this._className+"-select",o,n,void 0,this._snapType,function(){this._snapType=parseInt(this._snapSelect.selectedIndex-1,10)},"Select snapshot resolution");var s=document.createElement("a"),l=this._createButton(t+"-button",o,"snapshot",function(){var t,a=i.getCenter(),o=i.getPixelBounds(),n=i.getZoom();n>e.iipMaxZoom?(t=Math.pow(2,n-e.iipMaxZoom),n=e.iipMaxZoom):t=1;var l=e.iipImageSize[n].x*t,r=e.iipImageSize[n].y*t,c=o.max.x-o.min.x,h=o.max.y-o.min.y;s.href=e.getTileUrl({x:1,y:1}).replace(/JTL\=\d+\,\d+/g,"RGN="+o.min.x/l+","+o.min.y/r+","+c/l+","+h/r+"&WID="+(0===this._snapType?Math.floor(c/t):Math.floor(c/t/e.wcs.scale(n)))+"&CVT=jpeg"),s.download=e._title+"_"+L.IIPUtils.latLngToHMSDMS(a).replace(/[\s\:\.]/g,"")+".jpg",s.click()},"Take a snapshot of the displayed image");document.body.appendChild(s),a=this._addDialogLine("Print:",this._dialog),o=this._addDialogElement(a),l=this._createButton(t+"-button",o,"print",function(){var t=document.querySelector("#map > .leaflet-control-container");t.style.display="none",window.print(),t.style.display="unset"},"Print current map")}}),L.control.iip.snapshot=function(t){return new L.Control.IIP.Snapshot(t)},"undefined"!=typeof require)var $=require("jquery-browser");L.Control.Layers.IIP=L.Control.Layers.extend({options:{title:"overlay menu",collapsed:!0,position:"topright",autoZIndex:!0,fileMenu:!1,fileURL:"/fcgi-bin/iipsrv.fcgi?FIF=",fileRoot:"",fileTreeScript:"visiomatic/dist/filetree.php",fileProcessScript:"visiomatic/dist/processfits.php"},onAdd:function(t){return t._layerControl=this,this._initLayout(),this._update(),this._container},_initLayout:function(){var t="leaflet-control-layers",e=this._container=L.DomUtil.create("div",t);e.setAttribute("aria-haspopup",!0),L.Browser.touch?L.DomEvent.on(e,"click",L.DomEvent.stopPropagation):L.DomEvent.disableClickPropagation(e).disableScrollPropagation(e);var i=this._form=L.DomUtil.create("form",t+"-list");if(this.options.collapsed){L.Browser.android||L.DomEvent.on(e,{mouseover:this._expand,mouseout:this._collapse},this);var a=this._layersLink=L.DomUtil.create("a",t+"-toggle",e);a.href="#",a.title="Layers",L.Browser.touch?L.DomEvent.on(a,"click",L.DomEvent.stop).on(a,"click",this._expand,this):L.DomEvent.on(a,"focus",this._expand,this),L.DomEvent.on(i,"click",function(){setTimeout(L.bind(this._onInputClick,this),0)},this),this._map.on("click",this._collapse,this)}else this._expand();if(this._baseLayersList=L.DomUtil.create("div",t+"-base",i),this.options.fileMenu){var o=this._addButton=L.DomUtil.create("input",t+"-add",i);o.type="button",o.value="Add...",L.DomEvent.on(o,"click",this._openFileMenu,this)}this._separator=L.DomUtil.create("div",t+"-separator",i),this._overlaysList=L.DomUtil.create("div",t+"-overlays",i),e.appendChild(i)},_addItem:function(t){var e=this,i=L.DomUtil.create("div","leaflet-control-layers-item"),a=L.DomUtil.create("div","leaflet-control-layers-select",i);if(t.layer.notReady)L.DomUtil.create("div","leaflet-control-activity",a);else{var o,n=this._map.hasLayer(t.layer);t.overlay?(o=document.createElement("input"),o.type="checkbox",o.className="leaflet-control-layers-selector",o.defaultChecked=n):o=this._createRadioElement("leaflet-base-layers",n),o.layerId=L.stamp(t.layer),L.DomEvent.on(o,"click",this._onInputClick,this),a.appendChild(o)}var s=L.DomUtil.create("div","leaflet-control-layers-name",i);s.innerHTML=" "+t.name,s.style.textShadow="0px 0px 5px "+t.layer.nameColor;var l=L.DomUtil.create("input","leaflet-control-layers-trash",i);l.type="button",L.DomEvent.on(l,"click",function(){e.removeLayer(t.layer),t.notReady||e._map.removeLayer(t.layer)},this);var r=t.overlay?this._overlaysList:this._baseLayersList;return r.appendChild(i),i},_onInputClick:function(){var t,e,i,a=this._form.getElementsByTagName("input"),o=a.length;for(this._handlingClick=!0,t=0;o>t;t++)e=a[t],"layerId"in e&&(i=this._layers[e.layerId],e.checked&&!this._map.hasLayer(i.layer)?i.layer.addTo(this._map):!e.checked&&this._map.hasLayer(i.layer)&&this._map.removeLayer(i.layer));this._handlingClick=!1},_addDialogLine:function(t,e){var i=L.DomUtil.create("div",this._className+"-element",e),a=L.DomUtil.create("span",this._className+"-label",i);return a.innerHTML=t,i},_openFileMenu:function(){var t=this,e=L.DomUtil.create("div","leaflet-control-filemenu",this._map._controlContainer);e.title="Open file",this._addButton.disabled=!0,L.DomEvent.disableClickPropagation(e).disableScrollPropagation(e),$(".leaflet-control-filemenu").dialog({appendTo:"body",close:function(){L.DomUtil.remove(e),t._addButton.disabled=!1},show:{effect:"clip",duration:250},hide:{effect:"clip",duration:250},height:200});var i=L.DomUtil.create("div","leaflet-control-filetree",e);i.id="leaflet-filetree",$(document).ready(function(){$("#leaflet-filetree").fileTree({root:t.options.fileRoot,script:t.options.fileTreeScript},function(e){var i,a=t._map._layerControl,o=e.replace(/(^.*\/|\..*$)/g,"");a&&(i=new L.LayerGroup(null),i.notReady=!0,a.addBaseLayer(i,"converting "+o+"..."),a.options.collapsed&&a._expand()),$.post(t.options.fileProcessScript,{fitsname:e},function(e){e=e.trim();var a=L.tileLayer.iip(t.options.fileURL+e,{title:o});a.iipMetaReady?t._updateBaseLayer(i,a):a.once("metaload",function(){t._updateBaseLayer(i,a)})})})})},_updateBaseLayer:function(t,e){var i=this._map,a=i._layerControl;a.removeLayer(t),i.eachLayer(i.removeLayer),e.addTo(i),a.addBaseLayer(e,e._title),i.fire("baselayerchange"),a.options.collapsed&&a._collapse()}}),L.control.layers.iip=function(t,e,i){return new L.Control.Layers.IIP(t,e,i)},L.Control.Reticle=L.Control.extend({options:{position:"bottomleft"},onAdd:function(){var t=this._reticle=L.DomUtil.create("div","leaflet-reticle",this._map._controlContainer),e=t.style;e.position="absolute",e.left="50%",e.bottom="50%",e.textAlign="center",e.verticalAlign="middle",e.pointerEvents="none",t.innerHTML="";var i=this._container=L.DomUtil.create("div","leaflet-dummy");return i},onRemove:function(){this._reticle.parentNode.removeChild(this._reticle)}}),L.control.reticle=function(t){return new L.Control.Reticle(t)},L.Control.Scale.WCS=L.Control.Scale.extend({options:{position:"bottomleft",title:"Scale",maxWidth:128,metric:!1,imperial:!1,degrees:!0,pixels:!0,custom:!1,customScale:1,customUnits:"",planetRadius:6378137,updateWhenIdle:!1},_addScales:function(t,e,i){t.metric&&(this._mScale=L.DomUtil.create("div",e,i),this._mScale.title=t.metricTitle?t.metricTitle:t.title),t.imperial&&(this._iScale=L.DomUtil.create("div",e,i),this._iScale.title=t.imperialTitle?t.imperialTitle:t.title),t.degrees&&(this._dScale=L.DomUtil.create("div",e,i),this._dScale.title=t.degreesTitle?t.degreesTitle:t.title),t.pixels&&(this._pScale=L.DomUtil.create("div",e,i),this._pScale.title=t.pixelsTitle?t.pixelsTitle:t.title),t.custom&&(this._cScale=L.DomUtil.create("div",e,i),this._cScale.title=t.customTitle?t.customTitle:t.title),this.angular=t.metric||t.imperial||t.degrees},_update:function(){var t=this.options,e=this._map,i=e.options.crs;if(t.pixels&&i.options&&i.options.nzoom){var a=Math.pow(2,i.options.nzoom-1-e.getZoom());this._updatePixels(a*t.maxWidth)}if(t.custom&&i.options&&i.options.nzoom){var o=Math.pow(2,i.options.nzoom-1-e.getZoom())*t.customScale;this._updateCustom(o*t.maxWidth,t.customUnits)}if(this.angular){var n=e.getCenter(),s=Math.cos(n.lat*Math.PI/180),l=Math.sqrt(this._jacobian(n))*s,r=l*t.maxWidth;t.metric&&this._updateMetric(r*Math.PI/180*t.planetRadius),t.imperial&&this._updateImperial(r*Math.PI/180*t.planetRadius),t.degrees&&this._updateDegrees(r)}},_jacobian:function(t){var e=this._map,i=e.project(t),a=e.unproject(i.add([10,0])),o=e.unproject(i.add([0,10]));return.01*Math.abs((a.lng-t.lng)*(o.lat-t.lat)-(o.lng-t.lng)*(a.lat-t.lat))},_updateCustom:function(t,e){var i=this._cScale;if(t>1e9){var a=1e-9*t,o=this._getRoundNum(a);this._updateScale(i,o+" G"+e,o/a)}else if(t>1e6){var n=1e-6*t,s=this._getRoundNum(n);this._updateScale(i,s+" M"+e,s/n)}else if(t>1e3){var l=.001*t,r=this._getRoundNum(l);this._updateScale(i,r+" k"+e,r/l)}else{var c=this._getRoundNum(t);this._updateScale(i,c+" "+e,c/t)}},_updatePixels:function(t){var e=this._pScale;if(t>1e6){var i=1e-6*t,a=this._getRoundNum(i);this._updateScale(e,a+" Mpx",a/i)}else if(t>1e3){var o=.001*t,n=this._getRoundNum(o);this._updateScale(e,n+" kpx",n/o)}else{var s=this._getRoundNum(t);this._updateScale(e,s+" px",s/t)}},_updateDegrees:function(t){var e=3600*t,i=this._dScale;if(1>e){var a=1e3*e,o=this._getRoundNum(a);this._updateScale(i,o+" mas",o/a)}else if(60>e){var n=this._getRoundNum(e);this._updateScale(i,n+" &#34;",n/e)}else if(3600>e){var s=60*t,l=this._getRoundNum(s);this._updateScale(i,l+" &#39;",l/s)}else{var r=this._getRoundNum(t);this._updateScale(i,r+" &#176;",r/t)}}}),L.control.scale.wcs=function(t){return new L.Control.Scale.WCS(t)},L.Control.Sidebar=L.Control.extend({includes:L.Mixin.Events,options:{position:"left",title:"Toggle advanced menu",collapsed:!0,forceSeparateButton:!1},initialize:function(t){L.setOptions(this,t),this._sidebar=L.DomUtil.create("div","leaflet-container sidebar"),this.options.collapsed?L.DomUtil.addClass(this._sidebar,"collapsed"):L.DomUtil.addClass(this._sidebar,"closed"),L.DomUtil.addClass(this._sidebar,"sidebar-"+this.options.position),L.Browser.touch&&L.DomUtil.addClass(this._sidebar,"leaflet-touch"),this._tabs=L.DomUtil.create("div","sidebar-tabs",this._sidebar),this._tabitems=[],this._container=L.DomUtil.create("div","sidebar-content",this._sidebar),this._panes=[],this._closeButtons=[]},addTo:function(t){var e,i="leaflet-control-zoom-sidebar",a=t._controlContainer;return L.DomUtil.addClass(t._container,"sidebar-map"),a.insertBefore(this._sidebar,a.firstChild),L.DomEvent.disableClickPropagation(this._sidebar).disableScrollPropagation(this._sidebar),this._map=t,e=t.zoomControl&&!this.options.forceSeparateButton?t.zoomControl._container:L.DomUtil.create("div","leaflet-bar"),this._toggleButton=this._createButton(this.options.title,i+(this.options.collapsed?" collapsed":""),e),this},addTabList:function(){return this._tablist=L.DomUtil.create("ul","",this._tabs),this._tablist.setAttribute("role","tablist"),this._tablist},addTab:function(t,e,i,a,o){var n=this._tablist?this._tablist:this.addTabList(),s=L.DomUtil.create("li","",n),l=L.DomUtil.create("a",e,s);s.setAttribute("role","tab"),s._sidebar=this,l.href="#"+t,l.id=t+"-toggle",l.title=i,L.DomEvent.on(l,"click",L.DomEvent.preventDefault),L.DomEvent.on(l,"click",this._onClick,s),s.sideClass=o,this._tabitems.push(s);var r=L.DomUtil.create("div","sidebar-pane",this._container),c=L.DomUtil.create("h1","sidebar-header",r);c.innerHTML=i;var h=L.DomUtil.create("div","sidebar-close",c);return this._closeButtons.push(h),L.DomEvent.on(h,"click",this._onCloseClick,this),r.id=t,r.sideClass=o,r.appendChild(a),this._panes.push(r),r},removeFrom:function(){var t,e;for(this._map=null,t=this._tabitems.length-1;t>=0;t--)e=this._tabitems[t],L.DomEvent.off(e.querySelector("a"),"click",this._onClick);for(t=this._closeButtons.length-1;t>=0;t--)e=this._closeButtons[t],L.DomEvent.off(e,"click",this._onCloseClick,this);return this},open:function(t){var e,i;for(e=this._panes.length-1;e>=0;e--)i=this._panes[e],i.id===t?(L.DomUtil.addClass(i,"active"),i.sideClass&&L.DomUtil.addClass(this._sidebar,i.sideClass)):L.DomUtil.hasClass(i,"active")&&(L.DomUtil.removeClass(i,"active"),i.sideClass&&L.DomUtil.removeClass(this._sidebar,i.sideClass));for(e=this._tabitems.length-1;e>=0;e--)i=this._tabitems[e],i.querySelector("a").hash==="#"+t?L.DomUtil.addClass(i,"active"):L.DomUtil.hasClass(i,"active")&&L.DomUtil.removeClass(i,"active");return this.fire("content",{id:t}),L.DomUtil.hasClass(this._sidebar,"closed")&&(this.fire("opening"),L.DomUtil.removeClass(this._sidebar,"closed")),this},close:function(){for(var t=this._tabitems.length-1;t>=0;t--){var e=this._tabitems[t];L.DomUtil.hasClass(e,"active")&&(L.DomUtil.removeClass(e,"active"),e.sideClass&&L.DomUtil.removeClass(this._sidebar,e.sideClass))}return L.DomUtil.hasClass(this._sidebar,"closed")||(this.fire("closing"),L.DomUtil.addClass(this._sidebar,"closed")),this},toggle:function(){this.close(),L.DomUtil.hasClass(this._sidebar,"collapsed")?(L.DomUtil.addClass(this._sidebar,"closed"),this.fire("expanding"),L.DomUtil.removeClass(this._sidebar,"collapsed"),L.DomUtil.removeClass(this._toggleButton,"collapsed")):(L.DomUtil.removeClass(this._sidebar,"closed"),this.fire("collapsing"),L.DomUtil.addClass(this._sidebar,"collapsed"),L.DomUtil.addClass(this._toggleButton,"collapsed"))},_onClick:function(){L.DomUtil.hasClass(this,"active")?this._sidebar.close():L.DomUtil.hasClass(this,"disabled")||this._sidebar.open(this.querySelector("a").hash.slice(1))},_onCloseClick:function(){this.close()},_createButton:function(t,e,i){var a=L.DomUtil.create("a",e,i);return a.href="#",a.title=t,L.DomEvent.addListener(a,"click",L.DomEvent.stopPropagation).addListener(a,"click",L.DomEvent.preventDefault).addListener(a,"click",this.toggle,this),a}}),L.control.sidebar=function(t,e){return new L.Control.Sidebar(t,e)},L.Control.WCS=L.Control.extend({options:{position:"bottomleft",title:"Center coordinates. Click to change",coordinates:[{label:"RA, Dec",units:"HMS",nativeCelsys:!1}],centerQueryKey:"center",fovQueryKey:"fov"},onAdd:function(t){var e,i=this,a="leaflet-control-wcs",o=this._wcsdialog=L.DomUtil.create("div",a+"-dialog"),n=L.DomUtil.create("select",a+"-select",o),s=(document.createElement("option"),this.options.coordinates),l=[];L.DomEvent.disableClickPropagation(n),this._currentCoord=0,n.id="leaflet-coord-select",n.title="Switch coordinate system";for(var r in s)l[r]=document.createElement("option"),l[r].text=s[r].label,e=parseInt(r,10),l[r].value=e,0===e&&(l[r].selected=!0),n.add(l[r],null);L.DomEvent.on(n,"change",function(){i._currentCoord=n.value,i._onDrag()});var c=this._wcsinput=L.DomUtil.create("input",a+"-input",o);L.DomEvent.disableClickPropagation(c),c.type="text",c.title=this.options.title,"webkitSpeechRecognition"in window&&c.setAttribute("x-webkit-speech","x-webkit-speech"),t.on("move zoomend",this._onDrag,this),L.DomEvent.on(c,"focus",function(){this.setSelectionRange(0,this.value.length)},c),L.DomEvent.on(c,"change",function(){this.panTo(this._wcsinput.value)},this);var h=L.DomUtil.create("div",a+"-clipboard",o);return h.title="Copy to clipboard",L.DomEvent.on(h,"click",function(){var e={},i=location.href,a=this._map.options.crs,o=t.getCenter();L.IIPUtils.flashElement(this._wcsinput),i=L.IIPUtils.updateURL(i,this.options.centerQueryKey,L.IIPUtils.latLngToHMSDMS(o)),i=L.IIPUtils.updateURL(i,this.options.fovQueryKey,a.zoomToFov(t,t.getZoom(),o).toPrecision(4)),history.pushState(e,"",i),L.IIPUtils.copyToClipboard(i)},this),this._wcsdialog},onRemove:function(t){t.off("drag",this._onDrag)},_onDrag:function(){var t=this._map.getCenter(),e=this._map.options.crs,i=this.options.coordinates[this._currentCoord];
if(e.pixelFlag)this._wcsinput.value=t.lng.toFixed(0)+" , "+t.lat.toFixed(0);else switch(!i.nativeCelsys&&e.forceNativeCelsys?t=e.celsysToEq(t):i.nativeCelsys&&e.forceNativeCelsys===!1&&(t=e.eqToCelsys(t)),i.units){case"HMS":this._wcsinput.value=L.IIPUtils.latLngToHMSDMS(t);break;case"deg":this._wcsinput.value=t.lng.toFixed(5)+" , "+t.lat.toFixed(5);break;default:this._wcsinput.value=t.lng.toFixed(1)+" , "+t.lat.toFixed(1)}},panTo:function(t){var e=/^(-?\d+\.?\d*)\s*,\s*\+?(-?\d+\.?\d*)/g,i=(e.exec(t),this._map.options.crs),a=this.options.coordinates[this._currentCoord],o=i.parseCoords(t);o?i.pixelFlag?this._map.panTo(o):(!a.nativeCelsys&&i.forceNativeCelsys?o=i.eqToCelsys(o):a.nativeCelsys&&i.forceNativeCelsys===!1&&(o=i.celsysToEq(o)),this._map.panTo(o)):L.IIPUtils.requestURL("http://cdsweb.u-strasbg.fr/cgi-bin/nph-sesame/-oI/A?"+t,"getting coordinates for "+t,this._getCoordinates,this,10)},_getCoordinates:function(t,e){if(4===e.readyState)if(200===e.status){var i=e.responseText,a=t._map.options.crs.parseCoords(i,!0);a?(t._map.panTo(a),t._onDrag()):alert(i+": Unknown location")}else alert("There was a problem with the request to the Sesame service at CDS")}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.wcs=function(t){return new L.Control.WCS(t)};